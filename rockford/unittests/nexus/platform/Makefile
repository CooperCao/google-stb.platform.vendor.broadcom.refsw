############################################################
# Broadcom Proprietary and Confidential. (c)2015-2016 Broadcom. All rights reserved.
#
# This program is the proprietary software of Broadcom and/or its licensors,
# and may only be used, duplicated, modified or distributed pursuant to the terms and
# conditions of a separate, written license agreement executed between you and Broadcom
# (an "Authorized License").  Except as set forth in an Authorized License, Broadcom grants
# no license (express or implied), right to use, or waiver of any kind with respect to the
# Software, and Broadcom expressly reserves all rights in and to the Software and all
# intellectual property rights therein.  IF YOU HAVE NO AUTHORIZED LICENSE, THEN YOU
# HAVE NO RIGHT TO USE THIS SOFTWARE IN ANY WAY, AND SHOULD IMMEDIATELY
# NOTIFY BROADCOM AND DISCONTINUE ALL USE OF THE SOFTWARE.
#
# Except as expressly set forth in the Authorized License,
#
# 1.     This program, including its structure, sequence and organization, constitutes the valuable trade
# secrets of Broadcom, and you shall use all reasonable efforts to protect the confidentiality thereof,
# and to use this information only in connection with your use of Broadcom integrated circuit products.
#
# 2.     TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"
# AND WITH ALL FAULTS AND BROADCOM MAKES NO PROMISES, REPRESENTATIONS OR
# WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO
# THE SOFTWARE.  BROADCOM SPECIFICALLY DISCLAIMS ANY AND ALL IMPLIED WARRANTIES
# OF TITLE, MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE,
# LACK OF VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION
# OR CORRESPONDENCE TO DESCRIPTION. YOU ASSUME THE ENTIRE RISK ARISING OUT OF
# USE OR PERFORMANCE OF THE SOFTWARE.
#
# 3.     TO THE MAXIMUM EXTENT PERMITTED BY LAW, IN NO EVENT SHALL BROADCOM OR ITS
# LICENSORS BE LIABLE FOR (i) CONSEQUENTIAL, INCIDENTAL, SPECIAL, INDIRECT, OR
# EXEMPLARY DAMAGES WHATSOEVER ARISING OUT OF OR IN ANY WAY RELATING TO YOUR
# USE OF OR INABILITY TO USE THE SOFTWARE EVEN IF BROADCOM HAS BEEN ADVISED OF
# THE POSSIBILITY OF SUCH DAMAGES; OR (ii) ANY AMOUNT IN EXCESS OF THE AMOUNT
# ACTUALLY PAID FOR THE SOFTWARE ITSELF OR U.S. $1, WHICHEVER IS GREATER. THESE
# LIMITATIONS SHALL APPLY NOTWITHSTANDING ANY FAILURE OF ESSENTIAL PURPOSE OF
# ANY LIMITED REMEDY.
#
# Module Description:
#
############################################################

ifdef B_REFSW_REAL_NEXUS_TOP
NEXUS_TOP ?= ${B_REFSW_REAL_NEXUS_TOP}
endif
NEXUS_TOP ?= $(shell cd ../../../../nexus; pwd)

B_THIS_DIR := ${NEXUS_TOP}/../rockford/unittests/nexus/platform
ifdef B_REAL_TARGET
all: ${B_REAL_TARGET}
else
all: allocator
endif

x86.clean:
	${MAKE} -C ${NEXUS_TOP}/../rockford/applications/nexus/remote clean_x86

x86.nexus:
	${MAKE} -C ${NEXUS_TOP}/../rockford/applications/nexus/remote client_x86 NEXUS_PLATFORM_CLIENT_EXTRA_SOURCES=${B_THIS_DIR}/platform_heaps.c

x86: B_REFSW_OBJ_DIR:=obj.${NEXUS_PLATFORM}.client.x86
x86: B_REFSW_OBJ_ROOT?=${NEXUS_TOP}/../${B_REFSW_OBJ_DIR}
x86: x86.nexus ${B_THIS_DIR}/print_heaps.c
		cc ${B_THIS_DIR}/print_heaps.c ${B_REFSW_OBJ_ROOT}/nexus/bin/libnexus.so -m32 -lrt -o ${B_REFSW_OBJ_ROOT}/nexus/bin/print_heaps
	(cd ${B_REFSW_OBJ_ROOT}/nexus/bin; env LD_LIBRARY_PATH=. ./print_heaps `${MAKE} -f ${NEXUS_TOP}/nxclient/apps/list_all_boxmodes.mk NEXUS_TOP=${NEXUS_TOP} | sh |tail -1`) >${B_THIS_DIR}/heap_configs/heap_config_${NEXUS_PLATFORM}_SAGE_${SAGE_SUPPORT}.txt

# This requires Makefile.build generated by "BSEAV/tools/build/build.pl -Makefile Makefile.build.boxmode -log_stdout -default_board -single_revision autobuild"

B_REFSW_OBJ_DIR ?= obj.${NEXUS_PLATFORM}
B_REFSW_OBJ_ROOT ?= ${NEXUS_TOP}/../${B_REFSW_OBJ_DIR}
BINDIR := ${B_REFSW_OBJ_ROOT}/rockford/unittests/nexus/$(notdir ${CURDIR})
MAKEFILE_BUILD=${BINDIR}/Makefile.build

${MAKEFILE_BUILD}:
	mkdir -p ${BINDIR}
	${NEXUS_TOP}/../BSEAV/tools/build/build.pl -Makefile ${MAKEFILE_BUILD} -log_stdout -default_board -single_revision autobuild

SAGE_PLATFORMS="97250 97439 97445 97364 97366"
NO_SAGE_PLATFORMS="974371"
rebuild.all: ${MAKEFILE_BUILD}
	for plat in ${SAGE_PLATFORMS} ; do \
		${MAKE} -f ${MAKEFILE_BUILD} $$plat SAGE_SUPPORT=y B_REAL_TARGET=x86.clean; \
		${MAKE} -f ${MAKEFILE_BUILD} $$plat SAGE_SUPPORT=y B_REAL_TARGET=x86; \
	done
	for plat in ${SAGE_PLATFORMS} ${NO_SAGE_PLATFORMS} ; do \
		${MAKE} -f ${MAKEFILE_BUILD} $$plat SAGE_SUPPORT=n B_REAL_TARGET=x86.clean; \
		${MAKE} -f ${MAKEFILE_BUILD} $$plat SAGE_SUPPORT=n B_REAL_TARGET=x86;  \
	done

MAGNUM := ${NEXUS_TOP}/../magnum
B_REFSW_OS := linuxuser

include ${MAGNUM}/commonutils/lst/blst.inc
include ${MAGNUM}/basemodules/chp/bchp.inc
include ${MAGNUM}/basemodules/reg/breg.inc
include ${MAGNUM}/basemodules/std/bstd.inc
include ${MAGNUM}/basemodules/dbg/bdbg.inc
include ${MAGNUM}/basemodules/err/berr.inc
include ${MAGNUM}/basemodules/err/berr.inc
include ${MAGNUM}/basemodules/kni/bkni.inc
include ${MAGNUM}/basemodules/mma/bmma.inc
include ${MAGNUM}/basemodules/std/bstd.inc

BCHP_SOURCES:=
BREG_SOURCES:=
CFLAGS += -DBCHP_CHIP=GENERIC -DBCHP_VER=BCHP_VER_A0 -DBSTD_CPU_ENDIAN=BSTD_ENDIAN_LITTLE
CFLAGS += -g -Os -DBDBG_DEBUG_BUILD=1 -I${NEXUS_TOP}

SOURCES += $(sort $(foreach module, $(MAGNUM_MODULES), $($(module)_SOURCES)))
INCLUDES := $(addprefix -I,$(sort $(foreach module, $(MAGNUM_MODULES), $($(module)_INCLUDES))))
DEFINES := $(addprefix -D,$(sort $(foreach module, $(MAGNUM_MODULES), $($(module)_DEFINES))))
CFLAGS += ${INCLUDES} ${DEFINES}

SOURCES += heap_allocator.c
CFLAGS += -W -Wall

SRCS := $(notdir ${SOURCES})
OBJS := $(SRCS:%.c=${BINDIR}/%.o)



vpath %.c $(sort $(dir ${SOURCES}))

CDEP_FLAG = -MMD

BINDIR_EXISTS:=${BINDIR}/exists

${BINDIR}/exists:
	mkdir -p $@

EXTRA_CFLAGS ?= -m32
${BINDIR}/%.o : %.c ${BINDIR_EXISTS}
	@echo [Compile... $(notdir $<)]
	@$(CC) ${CDEP_FLAG} $(CFLAGS) $(COPT_FLAGS) ${EXTRA_CFLAGS} -c $< -o $@

${BINDIR}/allocator : ${OBJS}
	@echo [Link... $(notdir $@)]
	@${CC} -lpthread -lrt ${EXTRA_CFLAGS} ${OBJS} -o $@

allocator: ${BINDIR}/allocator

-include $(BINDIR)/*.d
