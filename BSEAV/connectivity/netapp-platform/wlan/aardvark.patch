diff -BNru aardvark01t_rel_6_37_14_88_org/src/include/siutils.h aardvark01t_rel_6_37_14_88/src/include/siutils.h
--- aardvark01t_rel_6_37_14_88_org/src/include/siutils.h	2014-03-10 19:43:54.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/include/siutils.h	2014-08-08 16:29:22.359063218 -0400
@@ -26,6 +26,10 @@
 #include "bcm_rpc.h"
 #endif
 
+#if defined(STB) && defined(BCMEXTNVM)
+#include "bcmsrom_fmt.h"
+#endif
+
 #include <bcmutils.h>
 /*
  * Data structure to export all chip specific common variables
@@ -59,6 +63,10 @@
 #if defined(WLC_HIGH) && !defined(WLC_LOW)
 	rpc_info_t *rpc;
 #endif
+#if defined(STB) && defined(BCMEXTNVM)
+	char 	wl_sromvars_map[VARS_MAX];
+#endif
+
 #ifdef SI_ENUM_BASE_VARIABLE
 	uint32  si_enum_base;
 #endif /* SI_ENUM_BASE_VARIABLE */
diff -BNru aardvark01t_rel_6_37_14_88_org/src/Makerules aardvark01t_rel_6_37_14_88/src/Makerules
--- aardvark01t_rel_6_37_14_88_org/src/Makerules	2014-03-10 19:44:02.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/Makerules	2014-08-08 16:29:22.359063218 -0400
@@ -186,11 +186,12 @@
 	ifeq ($(TARGETENV), freebsd)
 		GLDFLAGS = -static
 	endif
+# TGK: static -> -shared x2 -- weird missing "main" failures?!?!
 	ifeq ($(TARGETENV), linuxarm)
-		GLDFLAGS = -static
+		GLDFLAGS = -shared
 	endif
 	ifeq ($(TARGETENV), linuxarm_le)
-		GLDFLAGS = -static
+		GLDFLAGS = -shared
 	endif
 	ifeq ($(TARGETENV), android)
 		GLDFLAGS = -static
diff -BNru aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/common/p2plib_generic_osl.c aardvark01t_rel_6_37_14_88/src/p2p/p2plib/common/p2plib_generic_osl.c
--- aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/common/p2plib_generic_osl.c	2014-03-10 19:43:31.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/p2p/p2plib/common/p2plib_generic_osl.c	2014-08-08 16:29:22.363063620 -0400
@@ -1111,6 +1111,112 @@
 	return TRUE;
 }
 
+/* Steven: Adding API to set an IP Address without calling ifconfig.
+ * The following implementation is copied from NetAppPrivate_P_SetIPSettings()
+ * and NetAppPrivate_P_SetGateWay() in netapp_priv.c from STB */
+#if defined(linux)
+#include <linux/route.h>
+static int p2papi_osl_set_gateway(
+    int                 lPacketSocket,
+    const char          *pIFaceName,
+    int                 tGateway)
+{
+    struct  rtentry     rtent;
+    struct sockaddr_in  *pDest  = (struct sockaddr_in *)&rtent.rt_dst;
+    struct sockaddr_in  *pGW    = (struct sockaddr_in *)&rtent.rt_gateway;
+    struct sockaddr_in  *pMask  = (struct sockaddr_in *)&rtent.rt_genmask;
+
+    memset(&rtent,0,sizeof(struct rtentry));
+    rtent.rt_metric         = 1;
+    rtent.rt_window         = 0;
+    pDest->sin_family       = pGW->sin_family = pMask->sin_family = AF_INET;
+    pDest->sin_addr.s_addr  = tGateway;
+    pGW->sin_addr.s_addr    = 0;
+    pMask->sin_addr.s_addr  = 0xffffffff;
+    rtent.rt_flags          = RTF_UP | RTF_HOST;
+    rtent.rt_dev            = (char *)pIFaceName;
+
+    /* Add route for subnet */
+    if (ioctl(lPacketSocket, SIOCADDRT, &rtent) < 0)
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        return -1;
+    }
+
+    pDest->sin_addr.s_addr  = 0;
+    pGW->sin_addr.s_addr    = tGateway;
+    pMask->sin_addr.s_addr  = 0;
+    rtent.rt_flags          = RTF_UP | RTF_GATEWAY;
+
+    /* Add route for default gateway */
+    if (ioctl(lPacketSocket, SIOCADDRT, &rtent) < 0)
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        return -1;
+    }
+    return 0;
+}
+
+
+bool p2papi_osl_set_ap_ipaddr_linux(char *pIFaceName, uint32 ip, uint32 netmask)
+{
+    int                 lPacketSocket = 0;
+    int                 tRetCode = 0;
+    struct ifreq        ifr;
+    struct sockaddr_in  *p;
+
+    if ((lPacketSocket = socket(AF_INET, SOCK_DGRAM, 0)) < 0)
+    {
+        P2PERR2("%s socket(AF_PACKET) Error: %s", __FUNCTION__, strerror(errno));
+        return -1;
+    }
+
+    memset(&ifr, 0, sizeof(ifr));
+    strncpy(ifr.ifr_name, pIFaceName, sizeof(ifr.ifr_name)-1);
+
+    p = (struct sockaddr_in *)&(ifr.ifr_addr);
+
+    /* Set IP Address to 0 to kill all routes, this might fail
+     * if there are no routes so we ignore the error */
+    p->sin_family = AF_INET;
+    p->sin_addr.s_addr = 0;
+    if (ioctl(lPacketSocket, SIOCSIFADDR, &ifr) < 0)
+    {
+        BCMP2PLOG((BCMP2P_LOG_MED, TRUE,"%s(): Not routes in the table", __FUNCTION__));
+    }
+
+    /* IP ADDRESS */
+    p->sin_family = AF_INET;
+    p->sin_addr.s_addr = ip;
+    if ( (ioctl(lPacketSocket, SIOCSIFADDR, &ifr) < 0) && ip )
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        tRetCode = -1;
+        goto err_out;
+    }
+
+    if (ip)
+    {
+        /* NETMASK ADDRESS */
+        p = (struct sockaddr_in *)&(ifr.ifr_netmask);
+        p->sin_family = AF_INET;
+        p->sin_addr.s_addr = netmask;
+        if (ioctl(lPacketSocket, SIOCSIFNETMASK, &ifr) < 0)
+        {
+            BCMP2PLOG((BCMP2P_LOG_MED, TRUE,"%s(): Could not set netmask", __FUNCTION__));
+        }
+
+        /* GATEWAY ADDRESS */
+        tRetCode = p2papi_osl_set_gateway(lPacketSocket, pIFaceName, (ip & 0x000000ff) + 1);
+    }
+err_out:
+    if (lPacketSocket > 0)
+    {
+        close(lPacketSocket);
+    }
+    return tRetCode;
+}
+#endif
 /* Set a static IP addr/netmask for this AP peer device's P2P network
  * interface.
  */
@@ -1125,8 +1231,10 @@
 	socketSetIapId(iapId);
 	return TRUE;
 #endif
-
 #if defined(linux)
+#if 1
+	return (p2papi_osl_set_ap_ipaddr_linux(p2papi_osl_get_ap_mode_ifname(hdl), ip, netmask) >= 0);
+#else
 	char cmd[128];
 	(void) hdl;
 
@@ -1164,6 +1272,7 @@
 		(netmask & 0x000000ff));
 	BCMP2PLOG((BCMP2P_LOG_MED, TRUE, "p2papi_osl_set_ap_ipaddr: %s\n", cmd));
 	system(cmd);
+#endif /* New API */
 #endif   /* linux */
 
 #ifdef TARGETENV_android
@@ -1183,6 +1292,9 @@
 p2papi_osl_clear_ap_ipaddr(struct p2papi_instance_s* hdl)
 {
 #if defined(linux)
+#if 1 //defined(TARGETENV_BCMSTB)
+    return (p2papi_osl_set_ap_ipaddr_linux(p2papi_osl_get_ap_mode_ifname(hdl), 0, 0) >= 0);
+#else
 	char cmd[128];
 	(void) hdl;
 
@@ -1196,6 +1308,7 @@
 		p2papi_osl_get_ap_mode_ifname(hdl));
 	BCMP2PLOG((BCMP2P_LOG_MED, TRUE, "p2papi_osl_clear_ap_ipaddr: %s\n", cmd));
 	system(cmd);
+#endif
 #endif   /* linux */
 
 	return TRUE;
diff -BNru aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/include/p2plib_osl.h aardvark01t_rel_6_37_14_88/src/p2p/p2plib/include/p2plib_osl.h
--- aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/include/p2plib_osl.h	2014-03-10 19:43:32.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/p2p/p2plib/include/p2plib_osl.h	2014-08-08 16:29:22.363063620 -0400
@@ -370,6 +370,14 @@
 bool p2papi_osl_dhcp_end_server(struct p2papi_instance_s* hdl, void *dhcpd_hdl);
 
 
+/* Steven: Adding API to set an IP Address without calling ifconfig.
+ * The following implementation is copied from NetAppPrivate_P_SetIPSettings()
+ * and NetAppPrivate_P_SetGateWay() in netapp_priv.c from STB */
+#if defined(linux)
+bool p2papi_osl_set_ap_ipaddr_linux(char *pIFaceName, uint32 ip, uint32 netmask);
+#endif
+
+
 /*
  * Logging definitions
  */
diff -BNru aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/linux/p2posl_linux.c aardvark01t_rel_6_37_14_88/src/p2p/p2plib/linux/p2posl_linux.c
--- aardvark01t_rel_6_37_14_88_org/src/p2p/p2plib/linux/p2posl_linux.c	2014-03-10 19:43:32.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/p2p/p2plib/linux/p2posl_linux.c	2014-08-08 16:29:22.363063620 -0400
@@ -1095,11 +1095,64 @@
 	(void) ifname;
 }
 
+/* Steven: Adding IOCTL API to bring up/down the interface
+ * The following code was taken from netapp_priv.c the function:
+ * NetAppPrivateSetInterfaceUp()
+ */
+#if defined(linux)
+
+static int p2posl_set_iface(const char* pIFaceName, bool bUp)
+{
+    int             tRetCode = -1;
+    int             lPacketSocket = 0;
+    struct ifreq    ifr;
+    int             retry = 10;
+
+    memset(&ifr, 0, sizeof(ifr));
+
+    if ((lPacketSocket = socket(AF_INET, SOCK_DGRAM, 0)) < 0)
+    {
+        P2PERR3("%s()[%d]: iface=%s socket() Failed\n", __FUNCTION__, __LINE__, pIFaceName);
+        return -1;
+    }
+    strncpy(ifr.ifr_name, pIFaceName, sizeof(ifr.ifr_name)-1);
+
+    /*INTERFACE CONTROL (Up/Down) */
+    while ( (ioctl(lPacketSocket, SIOCGIFFLAGS, &ifr) < 0) && retry--)
+    {
+        p2posl_sleep_ms(10);
+    }
+
+    if (!retry)
+    {
+        P2PERR3("%s()[%d]: iface=%s Failed to set up and running!\n", __FUNCTION__, __LINE__, pIFaceName);
+        goto err_out;
+    }
+
+
+    ifr.ifr_flags = (bUp) ? (ifr.ifr_flags | IFF_UP | IFF_RUNNING) : (ifr.ifr_flags & ~(IFF_UP | IFF_RUNNING));
+    if (ioctl(lPacketSocket, SIOCSIFFLAGS, &ifr) < 0)
+    {
+        P2PERR3("%s()[%d]: iface=%s Failed", __FUNCTION__, __LINE__, pIFaceName);
+        goto err_out;
+    }
+    tRetCode = 0;
+err_out:
+    if (lPacketSocket > 0)
+    {
+        close(lPacketSocket);
+    }
+    return tRetCode;
+}
+#endif
 
 /* Bring up an OS wireless network interface */
 int
 p2posl_ifup(const char* ifname, void *hdl)
 {
+#if 1
+    return p2posl_set_iface(ifname, true);
+#else
 	int ret;
 	char cmd[80];
 	char *path = "";
@@ -1165,17 +1218,20 @@
 		return -1;
 	}
 
-
 	return 0;
+#endif
 }
 
 /* Bring down an OS wireless network interface */
 int
 p2posl_ifdown(const char* ifname)
 {
+#if 1
+    p2papi_osl_set_ap_ipaddr_linux(ifname, 0, 0);
+    return p2posl_set_iface(ifname, false);
+#else
 	int ret;
 	char cmd[80];
-
 #ifdef TARGETENV_android
 	snprintf(cmd, sizeof(cmd), "/system/bin/route del -host 255.255.255.255 %s\n",
 		ifname);
@@ -1207,6 +1263,7 @@
 	}
 
 	return 0;
+#endif
 }
 
 
diff -BNru aardvark01t_rel_6_37_14_88_org/src/shared/bcmsrom.c aardvark01t_rel_6_37_14_88/src/shared/bcmsrom.c
--- aardvark01t_rel_6_37_14_88_org/src/shared/bcmsrom.c	2014-03-10 19:43:30.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/shared/bcmsrom.c	2014-08-08 16:29:22.371064423 -0400
@@ -85,6 +85,9 @@
 
 #define SROM_CIS_SINGLE	1
 
+#if defined(STB) && defined(BCMEXTNVM)
+extern int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes);
+#endif
 
 #if !defined(BCMDONGLEHOST)
 static int initvars_srom_si(si_t *sih, osl_t *osh, void *curmap, char **vars, uint *count);
@@ -694,7 +697,7 @@
 
 /* BCMHOSTVARS is enabled only if WLTEST is enabled or BCMEXTNVM is enabled */
 #if (!defined(BCMDONGLEHOST) && defined(BCMHOSTVARS)) || (defined(BCMUSBDEV_BMAC) || \
-	defined(BCM_BMAC_VARS_APPEND))
+	defined(BCM_BMAC_VARS_APPEND)) || (defined(STB) && defined(BCMEXTNVM))
 /* It must end with pattern of "END" */
 static uint
 BCMATTACHFN(srom_vars_len)(char *vars)
@@ -4298,6 +4301,21 @@
 
 	BS_ERROR(("srom rev:%d\n", sromrev));
 
+#if defined(STB) && defined(BCMEXTNVM)
+	if (err) {
+		printk("wl:srom/otp not programmed, using external nvram file\n");
+
+		/* read from vars file */ 
+		if (!init_sromvars_map(sih, sih->chip, (void *)sih->wl_sromvars_map, sizeof(sih->wl_sromvars_map))) {
+			unsigned int len;
+			base = vp = (char *)sih->wl_sromvars_map;
+			len = srom_vars_len((char *)sih->wl_sromvars_map);
+			vp += len;
+			*vp++ = '\0';
+			goto varsdone;
+		}
+	}
+#endif
 
 	/* We want internal/wltest driver to come up with default sromvars so we can
 	 * program a blank SPROM/OTP.
@@ -4473,8 +4491,12 @@
 	if (base && (base != mfgsromvars))
 #else
 	if (base)
-#endif 
+#endif
+#if (defined(STB) && defined(BCMEXTNVM))
+		;
+#else
 		MFREE(osh, base, MAXSZ_NVRAM_VARS);
+#endif
 
 	MFREE(osh, srom, SROM_MAX);
 	return err;
diff -BNru aardvark01t_rel_6_37_14_88_org/src/shared/bcmsromio.c aardvark01t_rel_6_37_14_88/src/shared/bcmsromio.c
--- aardvark01t_rel_6_37_14_88_org/src/shared/bcmsromio.c	1969-12-31 19:00:00.000000000 -0500
+++ aardvark01t_rel_6_37_14_88/src/shared/bcmsromio.c	2014-08-08 16:29:22.371064423 -0400
@@ -0,0 +1,53 @@
+#ifdef WLC_LOW
+#ifndef LINUX_VERSION_CODE 
+#include <linuxver.h>
+#endif
+
+#define MAX_SROM_FILE_SIZE SROM_MAX
+
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,0)
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/module.h>
+#include <osl.h>
+#include <linux/fs.h>
+#include <linux/vmalloc.h>
+#include <linux/mm.h>
+#include <linux/slab.h>
+#include <linux/unistd.h>
+#include <linux/fcntl.h>
+#include <asm/uaccess.h>
+#include <typedefs.h>
+#include <bcmdevs.h>
+#include "bcmsrom_fmt.h"
+#include "siutils.h"
+#include "bcmutils.h"
+
+int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes);
+
+int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes) 
+{
+	void *fp = NULL;
+	char fname[32];
+	int ret = 0;
+
+	sprintf(fname, "/etc/wlan/bcm%x_vars.bin", chipId);
+
+	fp = (void*)osl_os_open_image(fname);
+	if (fp != NULL) {
+		while (osl_os_get_image_block(buf, nbytes, fp));
+		osl_os_close_image(fp);
+	}
+	else {
+		printk("Could not open %s file\n", fname);
+		ret = -1;
+	}
+
+	return ret;	
+}
+#else
+/* no longer maintained for linux 2.4, compare above */
+#error "kernel version not supported"
+
+#endif /* LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,0) */
+#endif /* WLC_LOW */
diff -BNru aardvark01t_rel_6_37_14_88_org/src/shared/dbus.c aardvark01t_rel_6_37_14_88/src/shared/dbus.c
--- aardvark01t_rel_6_37_14_88_org/src/shared/dbus.c	2014-03-10 19:43:27.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/shared/dbus.c	2014-08-08 16:29:22.371064423 -0400
@@ -44,6 +44,9 @@
 #include <linux/usb.h>
 #endif /* EHCI_FASTPATH_TX || EHCI_FASTPATH_RX */
 
+#include <linux/vmalloc.h>
+#define VMALLOC(osh, size)  vmalloc(size)
+#define VFREE(osh, addr, size)  vfree(addr)
 
 #if defined(BCM_DNGL_EMBEDIMAGE)
 /* zlib file format field ids etc from gzio.c */
@@ -706,8 +709,9 @@
 			nvram_words_pad = 4 - dbus_info->nvram_len % 4;
 
 		len = actual_fwlen + dbus_info->nvram_len + nvram_words_pad;
-#ifdef USBAP
+#if 1
 		/* Allocate virtual memory otherwise it might fail on embedded systems */
+		DBUSERR(("%s() Allocating Virtual memory of size %d \n", __FUNCTION__, len));
 		dbus_info->image = VMALLOC(dbus_info->pub.osh, len);
 #else
 		dbus_info->image = MALLOC(dbus_info->pub.osh, len);
@@ -854,7 +858,7 @@
 		err = DBUS_ERR;
 
 	if (dbus_info->nvram) {
-#ifdef USBAP
+#if 1
 		VFREE(dbus_info->pub.osh, dbus_info->image, dbus_info->image_len);
 #else
 		MFREE(dbus_info->pub.osh, dbus_info->image, dbus_info->image_len);
diff -BNru aardvark01t_rel_6_37_14_88_org/src/shared/dbus_usb_linux.c aardvark01t_rel_6_37_14_88/src/shared/dbus_usb_linux.c
--- aardvark01t_rel_6_37_14_88_org/src/shared/dbus_usb_linux.c	2014-03-10 19:43:27.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/shared/dbus_usb_linux.c	2014-08-08 16:29:22.375064824 -0400
@@ -3887,6 +3887,9 @@
 		case BCM43242_CHIP_ID:
 			strcat(fw_name, "43242");
 			break;
+		case BCM43238_CHIP_ID:
+			strcat(fw_name, "43238");
+			break;
 		case BCM43526_CHIP_ID:
 			strcat(fw_name, "43526");
 			break;
@@ -3921,6 +3924,9 @@
 		case BCM43236_CHIP_ID:
 			strcat(fw_name, "43236");
 			break;
+		case BCM43238_CHIP_ID:
+			strcat(fw_name, "43238");
+			break;
 		case BCM43242_CHIP_ID:
 			strcat(fw_name, "43242");
 			break;
diff -BNru aardvark01t_rel_6_37_14_88_org/src/shared/siutils.c aardvark01t_rel_6_37_14_88/src/shared/siutils.c
--- aardvark01t_rel_6_37_14_88_org/src/shared/siutils.c	2014-03-10 19:43:28.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/shared/siutils.c	2014-08-08 16:29:22.379065225 -0400
@@ -1480,6 +1480,9 @@
 #endif
 	nvram_exit((void *)si_local); /* free up nvram buffers */
 #endif /* !BCMDONGLEHOST  & STA */
+#if !defined(BCMHIGHSDIO)
+	nvram_exit((void *)sih);
+#endif
 
 #if !defined(BCMDONGLEHOST)
 	if (BUSTYPE(sih->bustype) == PCI_BUS) {
diff -BNru aardvark01t_rel_6_37_14_88_org/src/usbdev/usbdl/Makefile aardvark01t_rel_6_37_14_88/src/usbdev/usbdl/Makefile
--- aardvark01t_rel_6_37_14_88_org/src/usbdev/usbdl/Makefile	2014-03-10 19:43:58.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/usbdev/usbdl/Makefile	2014-08-08 16:29:22.379065225 -0400
@@ -18,7 +18,7 @@
 
 vpath %.c $(SRCBASE)/shared
 
-CFLAGS= -Wall -Wstrict-prototypes -g -O2 -I$(SRCBASE)/include -I$(SRCBASE)/common/include -I$(SRCBASE)/shared/zlib -DBCMTRXV2 -DUNRELEASEDCHIP
+CFLAGS= -Wall -Wstrict-prototypes -g -O2 -I$(SRCBASE)/include -I$(SRCBASE)/common/include -I$(SRCBASE)/shared/zlib -DBCMTRXV2 -DUNRELEASEDCHIP -fPIC
 
 LIBS = -lusb
 TARGET = $(OBJDIR)bcmdl
@@ -36,29 +36,24 @@
 	CLEAN = clean_linux
 	CFLAGS += -I../libusb
 	LDFLAGS += $(CROSS_LD_PATH)
-endif
-
+else
 ifeq ($(TARGETENV), linuxmips_be) 
 	OBJECTS += $(OBJDIR)usb_linux.o
 	COMPILE = mips-linux-gcc 
-	LIBS := -L$(LIBUSB_PATH)/.libs $(LIBUSB_PATH)/.libs/libusb.a
-	CFLAGS += -I$(LIBUSB_PATH) -DIL_BIGENDIAN
-endif
-
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include -DIL_BIGENDIAN
+else
 ifeq ($(TARGETENV), linuxmips)
 	TARGET_PREFIX := mipsel-linux-
 	OBJECTS += $(OBJDIR)usb_linux.o
-	CFLAGS += -I ../libusb
 	COMPILE = mipsel-linux-gcc 
 	CLEAN = clean_linux
-	LDFLAGS += -L$(LIBUSB_PATH)/.libs
-	LIBS= ../libusb/.libs/libusb.a
-	LIBS := -L$(LIBUSB_PATH)/.libs $(LIBUSB_PATH)/.libs/libusb.a
-	CFLAGS += -I$(LIBUSB_PATH)
+	LDFLAGS += -L$(LIBUSB_PATH)/lib
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include
 install: 
 	cp bcmdl $(SRCBASE)/router/mipsel-uclibc/target/bin
-endif
-
+else
 ifeq ($(TARGETENV), linux26mips)
 	TARGET_PREFIX := mipsel-uclibc-linux26-
 	TARGET := bcmdlmips26
@@ -69,13 +64,30 @@
 	LDFLAGS += -L /projects/hnd/tools/linux/lib/mips26
 install: 
 	cp bcmdl $(SRCBASE)/router/mipsel-uclibc/target/bin
-endif
-
+else
 ifeq ($(TARGETENV), macos)
 	TARGET = bcmdl_macos
 	CLEAN = clean_macos
 	COMPILE = xcodebuild
 	PROJECT = bcmdl.xcodeproj
+else
+ifeq ($(TARGETENV), linuxarm_le)
+	TARGET_PREFIX := arm-linux-
+	OBJECTS += $(OBJDIR)usb_linux.o
+	COMPILE = arm-linux-gcc 
+	CLEAN = clean_linux
+	LDFLAGS += -L$(LIBUSB_PATH)/lib
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include
+install: 
+	cp bcmdl $(SRCBASE)/router/armel-uclibc/target/bin
+else
+	$(error TARGETENV $(TARGETENV) is not defined)
+endif
+endif
+endif
+endif
+endif
 endif
 
 ifeq ($(BCMQT),1)
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/config/wlconfig_lx_wl_armle aardvark01t_rel_6_37_14_88/src/wl/config/wlconfig_lx_wl_armle
--- aardvark01t_rel_6_37_14_88_org/src/wl/config/wlconfig_lx_wl_armle	1969-12-31 19:00:00.000000000 -0500
+++ aardvark01t_rel_6_37_14_88/src/wl/config/wlconfig_lx_wl_armle	2014-08-08 16:29:22.379065225 -0400
@@ -0,0 +1,32 @@
+# Broadcom 802.11abg Networking Device Driver Configuration file for STB linux
+#
+# Copyright (C) 2012, Broadcom Corporation. All Rights Reserved.
+# 
+# Permission to use, copy, modify, and/or distribute this software for any
+# purpose with or without fee is hereby granted, provided that the above
+# copyright notice and this permission notice appear in all copies.
+# 
+# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
+# SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
+# OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
+# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+#
+# $Id: wlconfig_lx_wl_mips,v 1.4 2010-02-18 22:45:21 $
+#
+# src/wl/linux driver config file
+
+#include $(WLCFGDIR)/wlconfig_lx_wl_apdef
+#include $(WLCFGDIR)/wlconfig_lx_wl_stadef
+
+#BCMSUP_PSK=1
+NVRAMSTUBS=1
+WLLXIW=0
+STBLINUX=1
+
+#include $(WLCFGDIR)/wl.mk
+#all:
+#	@echo "WLFLAGS = $(WLFLAGS)"
+#	@echo "WLFILES = $(WLFILES)"
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/config/wlconfig_lx_wl_media aardvark01t_rel_6_37_14_88/src/wl/config/wlconfig_lx_wl_media
--- aardvark01t_rel_6_37_14_88_org/src/wl/config/wlconfig_lx_wl_media	2014-03-10 19:43:31.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wl/config/wlconfig_lx_wl_media	2014-08-08 16:29:22.379065225 -0400
@@ -37,7 +37,9 @@
 EXTENDED_VID_PID={ USB_DEVICE(0x0846, 0x9011) }, \
                  { USB_DEVICE(0x050d, 0xd321) }, \
                  { USB_DEVICE(0x1eda, 0x0bdc) }, \
-                 { USB_DEVICE(0x043E, 0x3001) }
+                 { USB_DEVICE(0x043E, 0x3001) }, \
+                 { USB_DEVICE(0x0471, 0x20E7) }, \
+                 { USB_DEVICE(0x13b1, 0x003a) }
 SEQ_CMDS=0
 WOWL=1
 WL_ASSOC_RECREATE=1
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/config/wl.mk aardvark01t_rel_6_37_14_88/src/wl/config/wl.mk
--- aardvark01t_rel_6_37_14_88_org/src/wl/config/wl.mk	2014-03-10 19:43:31.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wl/config/wl.mk	2014-08-08 16:29:22.387066028 -0400
@@ -1486,6 +1486,14 @@
         WLFLAGS += -DWLMEDIA_FLAMES
 endif
 
+ifeq ($(STBLINUX),1)
+	WLFLAGS += -DSTB
+	ifeq ($(BCMEXTNVM),1)
+		WLFLAGS += -DBCMEXTNVM -DBCM47XX
+		WLFILES_SRC_LO += src/shared/bcmsromio.c
+		VARCFILES_SRC += src/shared/bcm4360_vars.c
+	endif
+endif
 
 #ifdef WL_WFDLL
 ifeq ($(WL_WFDLL),1)
@@ -1532,6 +1540,13 @@
 endif
 #endif
 
+ifeq ($(STBLINUX),1)
+	WLFLAGS += -DSTB
+	ifeq ($(BCMEXTNVM),1)
+		WLFLAGS += -DBCMEXTNVM -DBCM47XX
+		WLFILES_SRC_LO += src/shared/bcmsromio.c
+	endif
+endif
 
 #ifndef LINUX_HYBRID
 # AP/ROUTER with SDSTD
@@ -2170,6 +2185,7 @@
 # Legacy WLFILES pathless definition, please use new src relative path
 # in make files.
 WLFILES := $(sort $(notdir $(WLFILES_SRC)))
+VARCFILES := $(sort $(notdir $(VARCFILES_SRC)))
 
 ifeq ($(AMPDU_HOSTREORDER), 1)
 	WLFLAGS += -DBRCMAPIVTW=128 -DWLAMPDU_HOSTREORDER
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/linux/Makefile aardvark01t_rel_6_37_14_88/src/wl/linux/Makefile
--- aardvark01t_rel_6_37_14_88_org/src/wl/linux/Makefile	2014-03-10 19:45:08.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wl/linux/Makefile	2014-08-08 16:29:22.387066028 -0400
@@ -141,7 +141,7 @@
 default all:
 	@echo "Using default target(s) $(DEFTARGETS)"
 	+$(MAKE) EXPANDED=true TARGETS="$(DEFTARGETS)" $(DEFTARGETS)
-native mipsel mipseb arm:
+native mipsel mipseb arm arm_le:
 	@echo "Using default target(s) for $@ architecture"
 	+$(MAKE) EXPANDED=true TARGETS="$(subst native,$@,$(DEFTARGETS))" \
 		$(subst native,$@,$(DEFTARGETS))
@@ -282,6 +282,10 @@
 
 DFLAGS += -DSRCBASE=\"$(SRCBASE)\" -DBCMDRIVER
 
+ifneq ($(filter arm,$(TARGETARCH)),)
+DFLAGS += -D__LINUX_ARM_ARCH__=7 -march=armv7-a
+endif
+
 ifneq ($(findstring comp,$(TARGET)),)
    DFLAGS += -DBCMUSBDEV_COMPOSITE
 endif
@@ -296,6 +300,10 @@
 IFLAGS += -I$(LINUXDIR_INC_BASE)/include
 IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated
 ifeq ($(STBLINUX),1)
+ifeq ($(call KERNEL_GE,3.8.0),TRUE)
+  IFLAGS += -I$(LINUXDIR)/include/uapi
+  IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated
+endif
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-brcmstb
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-generic
 else
@@ -304,6 +312,10 @@
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-default
 endif
 IFLAGS   += -I.
+ifeq ($(call KERNEL_GE,3.7.0),TRUE)
+  IFLAGS += -I$(LINUXDIR)/include/uapi
+  IFLAGS += -include $(LINUXDIR)/include/linux/kconfig.h
+endif
 
 IFLAGS   += -I$(SRCBASE)/wl/sys
 IFLAGS   += -I$(SRCBASE)/wl/phy
@@ -313,6 +325,9 @@
 IFLAGS   += -I$(SRCBASE)/shared
 IFLAGS   += -I$(SRCBASE)/shared/zlib
 
+IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated/
+IFLAGS += -I$(LINUXDIR_INC_BASE)/mach-brcmstb/include/
+
 ############################################################
 # Check if the dongle image is embedded
 ############################################################
@@ -380,7 +395,8 @@
   endif # dnglimage
 endif # high
 
-WFLAGS := -Wall -Wstrict-prototypes -Werror # -Wpointer-arith
+#WFLAGS := -Wall -Wstrict-prototypes -Werror # -Wpointer-arith
+WFLAGS := -Wall -Wstrict-prototypes -Werror -Wno-unused-local-typedefs -Wno-unused-variable -Wno-unused-function -Wno-unused-but-set-variable
 
 #disabled# # Kernel starting from fc15 need a gcc 4.6.+ compiler that is more stricter
 #disabled# # and doesn't allow warnings pass compilation step.
@@ -539,9 +555,9 @@
   ifneq ($(filter debug,$(INMAKE)),)
     DEBUG=1
   endif
-  ifeq ($(filter mipsel,$(INMAKE)),)
-    WLLXNOMIPSEL=1
-  endif
+  #ifeq ($(filter mipsel,$(INMAKE)),)
+  #  WLLXNOMIPSEL=1
+  #endif
 
   # Get remaining WL config, set flags and files
   include $(WLCONFFILE)
@@ -593,8 +609,10 @@
       endif
     endif
     ifneq ($(filter arm,$(INMAKE)),)
-      CROSS_COMPILE ?= armeb-linux-
-      DFLAGS += -DIL_BIGENDIAN
+### TGK...eh well, neither 'eb', nor -DIL_BIGENDIAN (see mips{el,eb})
+###      CROSS_COMPILE ?= armeb-linux-
+###      DFLAGS += -DIL_BIGENDIAN
+      CROSS_COMPILE ?= arm-linux-
       ifneq ($(filter nodebug,$(INMAKE)),)
         LDFLAGS += -S
       endif
@@ -618,6 +636,9 @@
     # except for __KERNEL__ !
     ifeq ($(findstring wluser,$(TARGET)),)
       CFLAGS += -D__KERNEL__
+      ifneq ($(filter arm,$(INMAKE)),)
+         CFLAGS += -D__LINUX_ARM_ARCH__=7
+      endif
     endif
     # we need to export this so the make from the kernel can know it
     WLCFLAGS = $(CFLAGS) -I$(shell pwd)
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/sys/wlc_ampdu_rx.h aardvark01t_rel_6_37_14_88/src/wl/sys/wlc_ampdu_rx.h
--- aardvark01t_rel_6_37_14_88_org/src/wl/sys/wlc_ampdu_rx.h	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wl/sys/wlc_ampdu_rx.h	2014-08-08 16:29:22.387066028 -0400
@@ -56,7 +56,9 @@
 extern bool wlc_ampdu_rx_aggr(ampdu_rx_info_t *ampdu_rx);
 extern bool wlc_ampdu_rxba_enable(ampdu_rx_info_t *ampdu_rx, uint8 tid);
 
-extern INLINE uint8 wlc_ampdu_get_rx_factor(wlc_info_t *wlc);
+/* FIXME */
+/*extern INLINE uint8 wlc_ampdu_get_rx_factor(wlc_info_t *wlc);*/
+extern uint8 wlc_ampdu_get_rx_factor(wlc_info_t *wlc);
 extern void wlc_ampdu_update_rx_factor(wlc_info_t *wlc, int vhtmode);
 extern void wlc_ampdu_update_ie_param(ampdu_rx_info_t *ampdu_rx);
 
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wl/sys/wl_linux.c aardvark01t_rel_6_37_14_88/src/wl/sys/wl_linux.c
--- aardvark01t_rel_6_37_14_88_org/src/wl/sys/wl_linux.c	2014-03-10 19:43:33.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wl/sys/wl_linux.c	2014-08-08 16:29:50.469917966 -0400
@@ -855,6 +855,10 @@
 #endif /* BCMDBG || BCMDBG_DUMP */
 #endif /* HNDCTF */
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(3, 10, 0)
+static const struct file_operations wl_proc_fops;
+#endif
+
 /**
  * attach to the WL device.
  *
@@ -1151,7 +1155,12 @@
 #if !defined(LINUX_HYBRID) && defined(CONFIG_PROC_FS)
 	/* create /proc/net/wl<unit> */
 	sprintf(tmp, "net/wl%d", wl->pub->unit);
-	create_proc_read_entry(tmp, 0, 0, wl_read_proc, (void*)wl);
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 10, 0))
+    /* create_proc_read_entry removed in linux 3.10.0, use proc_create_data() instead. */
+    proc_create_data(tmp, 0, 0, &wl_proc_fops, (void*)wl); 
+#else
+    create_proc_read_entry(tmp, 0, 0, wl_read_proc, (void*)wl);
+#endif /* #if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 10, 0)) */	
 #endif
 
 #ifdef BCMDBG
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/include/wps_api_osl.h aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/include/wps_api_osl.h
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/include/wps_api_osl.h	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/include/wps_api_osl.h	2014-08-08 16:29:22.391066430 -0400
@@ -61,7 +61,7 @@
 extern char *wps_osl_get_short_adapter_name();
 extern int wps_osl_get_mac(uint8 *mac);
 extern char *wps_osl_get_ssid();
-extern uint32 wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id);
+extern uint32 wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id);
 extern void wps_osl_deinit();
 extern void wps_osl_abort();
 extern uint32 wps_osl_setup_802_1x(uint8 *bssid);
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/include/wps_sdk.h aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/include/wps_sdk.h
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/include/wps_sdk.h	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/include/wps_sdk.h	2014-08-08 16:29:22.391066430 -0400
@@ -276,6 +276,8 @@
  * Function : wps_api_open
  * Parameters :
  *		adapter_id - Adapter identifier
+ *		bridge_id Bridge adaptor name that the interface is connected too (the interface to
+ *		listen for events on)
  *		cb_ctx  - Optional. If provided, the WPS status callback
  *			will be called with this context.
  *		callback - WPS status callback.
@@ -302,10 +304,10 @@
  *			serial Number = "5678"
  */
 #ifdef WFA_WPS_20_TESTBED
-BCM_WPSAPI bool wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback,
+BCM_WPSAPI bool wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback,
 	wps_devinf *devinf, wps20_testbed_inf *wps20_tbinf, bool ap_pin, bool version2);
 #else
-BCM_WPSAPI bool wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback,
+BCM_WPSAPI bool wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback,
 	wps_devinf *devinf, bool ap_pin, bool version2);
 #endif
 
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_api.c aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_api.c
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_api.c	2014-03-10 19:43:57.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_api.c	2014-08-08 16:29:22.395066831 -0400
@@ -732,10 +732,10 @@
 /* wps_api_open function must be called first, before any other wps api call */
 BCM_WPSAPI bool
 #ifdef WFA_WPS_20_TESTBED
-wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
+wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
 	wps20_testbed_inf *wps20_tbinf, bool ap_pin, bool b_v2)
 #else
-wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
+wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
 	bool ap_pin, bool b_v2)
 #endif /* WFA_WPS_20_TESTBED */
 {
@@ -794,7 +794,7 @@
 	wps_api_status_cb(&wps_api_wksp->cb, wps_api_wksp->cb_ctx, WPS_STATUS_INIT, NULL);
 
 	/* WPS hook init for adapter and led (HW) */
-	if (wps_hook_init(cb_ctx, callback, adapter_id) == false) {
+	if (wps_hook_init(cb_ctx, callback, adapter_id, bridge_id) == false) {
 		TUTRACE((TUTRACE_ERR, "wps_api_open : Failed to initial wireless adapter.\n"));
 		return false;
 	}
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_api_priv.h aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_api_priv.h
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_api_priv.h	2014-03-10 19:43:57.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_api_priv.h	2014-08-08 16:29:22.395066831 -0400
@@ -35,7 +35,7 @@
 
 extern bool wps_hook_create_profile(const struct _wps_credentials *credentials);
 extern int wps_hook_get_mac(uint8 *mac);
-extern bool wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id);
+extern bool wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id);
 extern void wps_hook_deinit();
 extern void wps_hook_abort();
 extern uint32 wps_hook_setup_802_1x(char *bssid);
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_hooks.c aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_hooks.c
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/common/wps_hooks.c	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/common/wps_hooks.c	2014-08-08 16:29:22.395066831 -0400
@@ -61,9 +61,9 @@
 
 /* Initial HW related */
 bool
-wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id)
+wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id, const char * bridge_id)
 {
-	uint32 retVal = wps_osl_init(cb_ctx, cb, adapter_id);
+	uint32 retVal = wps_osl_init(cb_ctx, cb, adapter_id, bridge_id);
 	return ((retVal == WPS_OSL_SUCCESS) ? true : false);
 }
 
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/Makefile aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/Makefile
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/Makefile	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/Makefile	2014-08-08 16:29:22.395066831 -0400
@@ -45,7 +45,7 @@
 WFA_TB ?= 0
 
 # Set CFLAGS
-CFLAGS = -Wall -Werror -Wnested-externs -fPIC -fno-strict-aliasing
+CFLAGS = -Wall -Werror -Wnested-externs -fPIC -fno-strict-aliasing -Wno-unused-but-set-variable
 ifeq ($(BLDTYPE),debug)
 	CFLAGS += -g -DDEBUG
 	# Mark mips compiler to produce debugging information that is understood by gdb
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_tester.c aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_tester.c
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_tester.c	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_tester.c	2014-08-08 16:29:22.395066831 -0400
@@ -343,11 +343,11 @@
 
 	/* 2. Open WPS */
 #ifdef WFA_WPS_20_TESTBED
-	bRet = wps_api_open(STRP(wps->ifname), NULL, _wps_join_callback,
+	bRet = wps_api_open(STRP(wps->ifname), STRP(wps->brname), NULL, _wps_join_callback,
 		_wps_my_devinf(&my_devinf, wps->transport_uuid), &wps->wps20_tbinf, wps->b_appin,
 		wps->b_v2);
 #else
-	bRet = wps_api_open(STRP(wps->ifname), NULL, _wps_join_callback,
+	bRet = wps_api_open(STRP(wps->ifname), STRP(wps->brname), NULL, _wps_join_callback,
 		_wps_my_devinf(&my_devinf, wps->transport_uuid), wps->b_appin, wps->b_v2);
 #endif
 	if (bRet == FALSE) {
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_tester.h aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_tester.h
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_tester.h	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_tester.h	2014-08-08 16:29:22.399067232 -0400
@@ -29,7 +29,8 @@
 
 	char bssid[6];
 	char ssid[33];
-	char ifname[16];
+    char ifname[16];
+    char brname[16];
 	char def_dhclient_pf[256];
 	char ip_addr[16];
 	char dhcp_cmd[256];
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_ui.c aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_ui.c
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_api_ui.c	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_api_ui.c	2014-08-08 16:29:22.399067232 -0400
@@ -968,11 +968,16 @@
 			wps->b_ssid = TRUE;
 			WPS_PRINT(("SSID : %s", wps->ssid));
 		}
-		else if (!strcmp(cmd, "-if")) {
-			WPS_ARGC_CHECK();
-			val = argv[index++]; argc--;
-			wps_strncpy(wps->ifname, val, sizeof(wps->ifname));
-		}
+        else if (!strcmp(cmd, "-if")) {
+            WPS_ARGC_CHECK();
+            val = argv[index++]; argc--;
+            wps_strncpy(wps->ifname, val, sizeof(wps->ifname));
+        }
+        else if (!strcmp(cmd, "-br")) {
+            WPS_ARGC_CHECK();
+            val = argv[index++]; argc--;
+            wps_strncpy(wps->brname, val, sizeof(wps->brname));
+        }
 		else if (!strcmp(cmd, "-bssid")) {
 			WPS_ARGC_CHECK();
 			/* 
diff -BNru aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_linux_osl.c aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_linux_osl.c
--- aardvark01t_rel_6_37_14_88_org/src/wps/wpsapi/linux/wps_linux_osl.c	2014-03-10 19:43:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_88/src/wps/wpsapi/linux/wps_linux_osl.c	2014-08-08 16:29:22.399067232 -0400
@@ -94,6 +94,8 @@
 WPS_OSL_T *wps_osl_wksp = NULL;
 
 static char ifname_lx[IFNAMSIZ] = "";
+static char ifname_br[IFNAMSIZ] = "";
+
 static uint8 peer_mac[6] = {0};
 static int eap_fd = -1; /* descriptor to raw socket  */
 static int ifindex = -1; /* interface index */
@@ -159,6 +161,12 @@
 
 	ifr.ifr_name[0] = '\0';
 
+	if (ifname_br[0] != '\0')
+    {
+	    strncpy(ifname, ifname_br, ifname_len);
+	    return 0;
+    }
+
 	if (!(fp = fopen(proc_net_dev, "r")))
 		return ret;
 
@@ -631,7 +639,7 @@
 		memcpy(peer_mac, bssid, 6);
 
 	memset(&ifr, 0, sizeof(ifr));
-	wps_strncpy(ifr.ifr_name, ifname_lx, sizeof(ifr.ifr_name));
+	wps_strncpy(ifr.ifr_name, ifname_br[0] ? ifname_br : ifname_lx, sizeof(ifr.ifr_name));
 
 	err = ioctl(eap_fd, SIOCGIFINDEX, &ifr);
 	if (err < 0) {
@@ -645,15 +653,24 @@
 
 	ll.sll_family = PF_PACKET;
 	ll.sll_ifindex = ifr.ifr_ifindex;
-	ifindex  = ifr.ifr_ifindex;
 	ll.sll_protocol = htons(ETH_8021X_PROT);
 	if (bind(eap_fd, (struct sockaddr *) &ll, sizeof(ll)) < 0) {
-		WPS_DEBUG(("Bind interface failed\n"));
+		WPS_DEBUG(( "Bind interface failed\n"));
 		close(eap_fd);
 		eap_fd = -1;
 		return WPS_OSL_ERROR;
 	}
 
+	wps_strncpy(ifr.ifr_name, ifname_lx, sizeof(ifr.ifr_name));
+	err = ioctl(eap_fd, SIOCGIFINDEX, &ifr);
+	if (err < 0) {
+		WPS_DEBUG(( "Get interface index failed\n"));
+		close(eap_fd);
+		eap_fd = -1;
+		return WPS_OSL_ERROR;
+	}
+	ifindex  = ifr.ifr_ifindex;
+
 	return WPS_OSL_SUCCESS;
 }
 
@@ -841,7 +858,7 @@
 }
 
 uint32
-wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id)
+wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id)
 {
 	char *ifname = (char*) adapter_id;
 	char dyn_name[IFNAMSIZ];
@@ -870,6 +887,11 @@
 		ifname = dyn_name;
 	}
 
+	if (bridge_id != NULL)
+	{
+	    wps_strncpy(ifname_br, bridge_id, sizeof(ifname_br));
+	}
+
 	/* Save this specific interface for further use */
 	wps_strncpy(ifname_lx, ifname, sizeof(ifname_lx));
 
@@ -926,6 +948,8 @@
 		free(wps_osl_wksp);
 		wps_osl_wksp = NULL;
 	}
+    memset(ifname_br, 0, sizeof(ifname_br));
+    memset(ifname_lx, 0, sizeof(ifname_lx));
 }
 
 void
@@ -1074,8 +1098,40 @@
 	list->version = WL_BSS_INFO_VERSION;
 	scan_bss = list->bss_info;
 
-	/* receive scan result */
-	while (1) {
+    /* receive scan result */
+#define SCAN_TIMEOUT 10000
+#define SCAN_WAIT_TIME_MS 50
+
+    /* receive scan result */
+    while (1) {
+        int loop = 0;
+        int retcode = 0;
+        while ((loop++*SCAN_WAIT_TIME_MS) < SCAN_TIMEOUT) {
+            fd_set tFDSet;
+            struct timeval tm;
+            tm.tv_sec  = 0;
+            tm.tv_usec = SCAN_WAIT_TIME_MS*1000;
+
+            FD_ZERO(&tFDSet);
+            FD_SET(fd, &tFDSet);
+            retcode = select(fd + 1, &tFDSet, NULL, NULL, &tm);
+
+            if (wps_osl_wksp && wps_osl_wksp->b_abort) {
+                WPS_DEBUG(("%s(): Received the abort!\n", __FUNCTION__));
+                goto exit1;
+            }
+
+            if (retcode < 0) {
+               goto exit1;
+            }
+            else if (retcode > 0) {
+                break;
+            }
+        }
+        if (retcode == 0) {
+            goto exit1;
+        }
+
 		octets = recv(fd, data, ESCAN_EVENTS_BUFFER_SIZE, 0);
 		if (octets < 0) {
 			WPS_DEBUG(("escan result recv failed; recvBytes = %d\n", octets));
diff -BNru aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/BcmP2PAPI.c aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/BcmP2PAPI.c
--- aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/BcmP2PAPI.c	2014-08-12 18:11:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/BcmP2PAPI.c	2014-12-16 09:50:49.431994323 -0500
@@ -396,7 +396,7 @@
 /* Create a P2P Group and act as a Group Owner */
 BCMP2P_API BCMP2P_STATUS
 BCMP2PCreateGroup(BCMP2PHandle p2pHandle, unsigned char *name,
-	BCMP2P_BOOL bAutoRestartWPS)
+	BCMP2P_BOOL bAutoRestartWPS, BCMP2P_BOOL bSoftAp)
 {
 	p2papi_instance_t* hdl = (p2papi_instance_t*) p2pHandle;
 
@@ -405,6 +405,8 @@
 
 	p2papi_enable_p2p(hdl, TRUE);
 
+	hdl->bSoftAp= bSoftAp;
+
 	if (createGroupOverrideFn) {
 		return createGroupOverrideFn(p2pHandle, name,
 			bAutoRestartWPS ? true : false);
@@ -1962,7 +1964,7 @@
 			goto exit;
 		}
 		status = BCMP2PCreateGroup(p2pHandle,
-			persist->ssid, BCMP2P_TRUE);
+			persist->ssid, BCMP2P_TRUE, BCMP2P_FALSE);
 		if (status != BCMP2P_SUCCESS) {
 			BCMP2PLOG((BCMP2P_LOG_MED, TRUE,
 				"BCMP2PCreateGroup failed %d\n", status));
diff -BNru aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/p2plib_api.h aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/p2plib_api.h
--- aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/p2plib_api.h	2014-08-12 18:11:56.000000000 -0400
+++ aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/p2plib_api.h	2014-12-16 09:50:49.431994323 -0500
@@ -825,6 +825,7 @@
 	uint8  acBK;
 	uint8  acVI;
 	uint8  acVO;
+	bool bSoftAp;
 } p2papi_instance_t;
 
 
diff -BNru aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/p2psig/p2plib_connect.c aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/p2psig/p2plib_connect.c
--- aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/common/p2psig/p2plib_connect.c	2014-08-12 18:11:54.000000000 -0400
+++ aardvark01t_rel_6_37_14_105/src/p2p/p2plib/common/p2psig/p2plib_connect.c	2014-12-16 09:50:49.431994323 -0500
@@ -3066,7 +3066,7 @@
 	 * the random "DIRECT-xy" ssid generated earlier.  This is for the case
 	 * if reinvoking a persistent group.
 	 */
-	if (hdl->enable_p2p) {
+    if (hdl->enable_p2p && !hdl->bSoftAp) {
 		if (memcmp((char*)ssid, "DIRECT-", strlen("DIRECT-")) == 0) {
 			strncpy(hdl->credentials.ssid, (char*)ssid,
 				sizeof(hdl->credentials.ssid));
diff -BNru aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/include/BcmP2PAPI.h aardvark01t_rel_6_37_14_105/src/p2p/p2plib/include/BcmP2PAPI.h
--- aardvark01t_rel_6_37_14_105_org/src/p2p/p2plib/include/BcmP2PAPI.h	2014-08-12 18:11:55.000000000 -0400
+++ aardvark01t_rel_6_37_14_105/src/p2p/p2plib/include/BcmP2PAPI.h	2014-12-16 09:50:49.435994675 -0500
@@ -2422,7 +2422,8 @@
  */
 BCMP2P_API BCMP2P_STATUS  BCMP2PCreateGroup(BCMP2PHandle p2pHandle,
                                             BCMP2P_UINT8 *name,
-                                            BCMP2P_BOOL bWaitForever);
+                                            BCMP2P_BOOL bWaitForever,
+                                            BCMP2P_BOOL bSoftAp);
 
 
 /**
