diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/include/siutils.h aard37rc14_rel_6_37_4_8_PCIe/src/include/siutils.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/include/siutils.h	2013-10-21 20:41:32.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/include/siutils.h	2014-05-13 11:04:00.866136324 -0400
@@ -26,6 +26,10 @@
 #include "bcm_rpc.h"
 #endif

+#if defined(STB) && defined(BCMEXTNVM)
+#include "bcmsrom_fmt.h"
+#endif
+
 #include <bcmutils.h>
 /*
  * Data structure to export all chip specific common variables
@@ -59,6 +63,10 @@
 #if defined(WLC_HIGH) && !defined(WLC_LOW)
	rpc_info_t *rpc;
 #endif
+#if defined(STB) && defined(BCMEXTNVM)
+	char 	wl_sromvars_map[VARS_MAX];
+#endif
+
 #ifdef SI_ENUM_BASE_VARIABLE
	uint32  si_enum_base;
 #endif /* SI_ENUM_BASE_VARIABLE */
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/Makerules aard37rc14_rel_6_37_4_8_PCIe/src/Makerules
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/Makerules	2013-10-21 20:41:09.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/Makerules	2014-05-13 11:04:00.870136732 -0400
@@ -186,11 +186,12 @@
	ifeq ($(TARGETENV), freebsd)
		GLDFLAGS = -static
	endif
+# TGK: static -> -shared x2 -- weird missing "main" failures?!?!
	ifeq ($(TARGETENV), linuxarm)
-		GLDFLAGS = -static
+		GLDFLAGS = -shared
	endif
	ifeq ($(TARGETENV), linuxarm_le)
-		GLDFLAGS = -static
+		GLDFLAGS = -shared
	endif
	ifeq ($(TARGETENV), android)
		GLDFLAGS = -static
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/common/p2plib_generic_osl.c aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/common/p2plib_generic_osl.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/common/p2plib_generic_osl.c	2013-10-21 20:41:08.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/common/p2plib_generic_osl.c	2014-05-13 11:04:00.870136732 -0400
@@ -1111,6 +1111,112 @@
	return TRUE;
 }

+/* Steven: Adding API to set an IP Address without calling ifconfig.
+ * The following implementation is copied from NetAppPrivate_P_SetIPSettings()
+ * and NetAppPrivate_P_SetGateWay() in netapp_priv.c from STB */
+#if defined(linux)
+#include <linux/route.h>
+static int p2papi_osl_set_gateway(
+    int                 lPacketSocket,
+    const char          *pIFaceName,
+    int                 tGateway)
+{
+    struct  rtentry     rtent;
+    struct sockaddr_in  *pDest  = (struct sockaddr_in *)&rtent.rt_dst;
+    struct sockaddr_in  *pGW    = (struct sockaddr_in *)&rtent.rt_gateway;
+    struct sockaddr_in  *pMask  = (struct sockaddr_in *)&rtent.rt_genmask;
+
+    memset(&rtent,0,sizeof(struct rtentry));
+    rtent.rt_metric         = 1;
+    rtent.rt_window         = 0;
+    pDest->sin_family       = pGW->sin_family = pMask->sin_family = AF_INET;
+    pDest->sin_addr.s_addr  = tGateway;
+    pGW->sin_addr.s_addr    = 0;
+    pMask->sin_addr.s_addr  = 0xffffffff;
+    rtent.rt_flags          = RTF_UP | RTF_HOST;
+    rtent.rt_dev            = (char *)pIFaceName;
+
+    /* Add route for subnet */
+    if (ioctl(lPacketSocket, SIOCADDRT, &rtent) < 0)
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        return -1;
+    }
+
+    pDest->sin_addr.s_addr  = 0;
+    pGW->sin_addr.s_addr    = tGateway;
+    pMask->sin_addr.s_addr  = 0;
+    rtent.rt_flags          = RTF_UP | RTF_GATEWAY;
+
+    /* Add route for default gateway */
+    if (ioctl(lPacketSocket, SIOCADDRT, &rtent) < 0)
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        return -1;
+    }
+    return 0;
+}
+
+
+bool p2papi_osl_set_ap_ipaddr_linux(char *pIFaceName, uint32 ip, uint32 netmask)
+{
+    int                 lPacketSocket = 0;
+    int                 tRetCode = 0;
+    struct ifreq        ifr;
+    struct sockaddr_in  *p;
+
+    if ((lPacketSocket = socket(AF_INET, SOCK_DGRAM, 0)) < 0)
+    {
+        P2PERR2("%s socket(AF_PACKET) Error: %s", __FUNCTION__, strerror(errno));
+        return -1;
+    }
+
+    memset(&ifr, 0, sizeof(ifr));
+    strncpy(ifr.ifr_name, pIFaceName, sizeof(ifr.ifr_name)-1);
+
+    p = (struct sockaddr_in *)&(ifr.ifr_addr);
+
+    /* Set IP Address to 0 to kill all routes, this might fail
+     * if there are no routes so we ignore the error */
+    p->sin_family = AF_INET;
+    p->sin_addr.s_addr = 0;
+    if (ioctl(lPacketSocket, SIOCSIFADDR, &ifr) < 0)
+    {
+        BCMP2PLOG((BCMP2P_LOG_MED, TRUE,"%s(): Not routes in the table", __FUNCTION__));
+    }
+
+    /* IP ADDRESS */
+    p->sin_family = AF_INET;
+    p->sin_addr.s_addr = ip;
+    if ( (ioctl(lPacketSocket, SIOCSIFADDR, &ifr) < 0) && ip )
+    {
+        P2PERR3("%s()[%d]: Failed error:%s", __FUNCTION__, __LINE__, strerror(errno));
+        tRetCode = -1;
+        goto err_out;
+    }
+
+    if (ip)
+    {
+        /* NETMASK ADDRESS */
+        p = (struct sockaddr_in *)&(ifr.ifr_netmask);
+        p->sin_family = AF_INET;
+        p->sin_addr.s_addr = netmask;
+        if (ioctl(lPacketSocket, SIOCSIFNETMASK, &ifr) < 0)
+        {
+            BCMP2PLOG((BCMP2P_LOG_MED, TRUE,"%s(): Could not set netmask", __FUNCTION__));
+        }
+
+        /* GATEWAY ADDRESS */
+        tRetCode = p2papi_osl_set_gateway(lPacketSocket, pIFaceName, (ip & 0x000000ff) + 1);
+    }
+err_out:
+    if (lPacketSocket > 0)
+    {
+        close(lPacketSocket);
+    }
+    return tRetCode;
+}
+#endif
 /* Set a static IP addr/netmask for this AP peer device's P2P network
  * interface.
  */
@@ -1125,8 +1231,10 @@
	socketSetIapId(iapId);
	return TRUE;
 #endif
-
 #if defined(linux)
+#if 1
+	return (p2papi_osl_set_ap_ipaddr_linux(p2papi_osl_get_ap_mode_ifname(hdl), ip, netmask) >= 0);
+#else
	char cmd[128];
	(void) hdl;

@@ -1164,6 +1272,7 @@
		(netmask & 0x000000ff));
	BCMP2PLOG((BCMP2P_LOG_MED, TRUE, "p2papi_osl_set_ap_ipaddr: %s\n", cmd));
	system(cmd);
+#endif /* New API */
 #endif   /* linux */

 #ifdef TARGETENV_android
@@ -1183,6 +1292,9 @@
 p2papi_osl_clear_ap_ipaddr(struct p2papi_instance_s* hdl)
 {
 #if defined(linux)
+#if 1 //defined(TARGETENV_BCMSTB)
+    return (p2papi_osl_set_ap_ipaddr_linux(p2papi_osl_get_ap_mode_ifname(hdl), 0, 0) >= 0);
+#else
	char cmd[128];
	(void) hdl;

@@ -1196,6 +1308,7 @@
		p2papi_osl_get_ap_mode_ifname(hdl));
	BCMP2PLOG((BCMP2P_LOG_MED, TRUE, "p2papi_osl_clear_ap_ipaddr: %s\n", cmd));
	system(cmd);
+#endif
 #endif   /* linux */

	return TRUE;
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/include/p2plib_osl.h aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/include/p2plib_osl.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/include/p2plib_osl.h	2013-10-21 20:41:08.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/include/p2plib_osl.h	2014-05-13 11:04:00.870136732 -0400
@@ -370,6 +370,14 @@
 bool p2papi_osl_dhcp_end_server(struct p2papi_instance_s* hdl, void *dhcpd_hdl);


+/* Steven: Adding API to set an IP Address without calling ifconfig.
+ * The following implementation is copied from NetAppPrivate_P_SetIPSettings()
+ * and NetAppPrivate_P_SetGateWay() in netapp_priv.c from STB */
+#if defined(linux)
+bool p2papi_osl_set_ap_ipaddr_linux(char *pIFaceName, uint32 ip, uint32 netmask);
+#endif
+
+
 /*
  * Logging definitions
  */
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/linux/p2posl_linux.c aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/linux/p2posl_linux.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/p2p/p2plib/linux/p2posl_linux.c	2013-10-21 20:41:08.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/p2p/p2plib/linux/p2posl_linux.c	2014-05-13 11:04:00.874137139 -0400
@@ -1095,11 +1095,64 @@
	(void) ifname;
 }

+/* Steven: Adding IOCTL API to bring up/down the interface
+ * The following code was taken from netapp_priv.c the function:
+ * NetAppPrivateSetInterfaceUp()
+ */
+#if defined(linux)
+
+static int p2posl_set_iface(const char* pIFaceName, bool bUp)
+{
+    int             tRetCode = -1;
+    int             lPacketSocket = 0;
+    struct ifreq    ifr;
+    int             retry = 10;
+
+    memset(&ifr, 0, sizeof(ifr));
+
+    if ((lPacketSocket = socket(AF_INET, SOCK_DGRAM, 0)) < 0)
+    {
+        P2PERR3("%s()[%d]: iface=%s socket() Failed\n", __FUNCTION__, __LINE__, pIFaceName);
+        return -1;
+    }
+    strncpy(ifr.ifr_name, pIFaceName, sizeof(ifr.ifr_name)-1);
+
+    /*INTERFACE CONTROL (Up/Down) */
+    while ( (ioctl(lPacketSocket, SIOCGIFFLAGS, &ifr) < 0) && retry--)
+    {
+        p2posl_sleep_ms(10);
+    }
+
+    if (!retry)
+    {
+        P2PERR3("%s()[%d]: iface=%s Failed to set up and running!\n", __FUNCTION__, __LINE__, pIFaceName);
+        goto err_out;
+    }
+
+
+    ifr.ifr_flags = (bUp) ? (ifr.ifr_flags | IFF_UP | IFF_RUNNING) : (ifr.ifr_flags & ~(IFF_UP | IFF_RUNNING));
+    if (ioctl(lPacketSocket, SIOCSIFFLAGS, &ifr) < 0)
+    {
+        P2PERR3("%s()[%d]: iface=%s Failed", __FUNCTION__, __LINE__, pIFaceName);
+        goto err_out;
+    }
+    tRetCode = 0;
+err_out:
+    if (lPacketSocket > 0)
+    {
+        close(lPacketSocket);
+    }
+    return tRetCode;
+}
+#endif

 /* Bring up an OS wireless network interface */
 int
 p2posl_ifup(const char* ifname, void *hdl)
 {
+#if 1
+    return p2posl_set_iface(ifname, true);
+#else
	int ret;
	char cmd[80];
	char *path = "";
@@ -1165,17 +1218,20 @@
		return -1;
	}

-
	return 0;
+#endif
 }

 /* Bring down an OS wireless network interface */
 int
 p2posl_ifdown(const char* ifname)
 {
+#if 1
+    p2papi_osl_set_ap_ipaddr_linux(ifname, 0, 0);
+    return p2posl_set_iface(ifname, false);
+#else
	int ret;
	char cmd[80];
-
 #ifdef TARGETENV_android
	snprintf(cmd, sizeof(cmd), "/system/bin/route del -host 255.255.255.255 %s\n",
		ifname);
@@ -1207,6 +1263,7 @@
	}

	return 0;
+#endif
 }


diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/bcmsrom.c aard37rc14_rel_6_37_4_8_PCIe/src/shared/bcmsrom.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/bcmsrom.c	2013-10-21 20:41:20.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/shared/bcmsrom.c	2014-05-13 11:04:00.874137139 -0400
@@ -86,6 +86,9 @@

 #define SROM_CIS_SINGLE	1

+#if defined(STB) && defined(BCMEXTNVM)
+extern int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes);
+#endif

 #if !defined(BCMDONGLEHOST)
 static int initvars_srom_si(si_t *sih, osl_t *osh, void *curmap, char **vars, uint *count);
@@ -695,7 +698,7 @@

 /* BCMHOSTVARS is enabled only if WLTEST is enabled or BCMEXTNVM is enabled */
 #if (!defined(BCMDONGLEHOST) && defined(BCMHOSTVARS)) || (defined(BCMUSBDEV_BMAC) || \
-	defined(BCM_BMAC_VARS_APPEND))
+	defined(BCM_BMAC_VARS_APPEND)) || (defined(STB) && defined(BCMEXTNVM))
 /* It must end with pattern of "END" */
 static uint
 BCMATTACHFN(srom_vars_len)(char *vars)
@@ -4295,6 +4298,21 @@

	BS_ERROR(("srom rev:%d\n", sromrev));

+#if defined(STB) && defined(BCMEXTNVM)
+	if (err) {
+		printk("wl:srom/otp not programmed, using external nvram file\n");
+
+		/* read from vars file */
+		if (!init_sromvars_map(sih, sih->chip, (void *)sih->wl_sromvars_map, sizeof(sih->wl_sromvars_map))) {
+			unsigned int len;
+			base = vp = (char *)sih->wl_sromvars_map;
+			len = srom_vars_len((char *)sih->wl_sromvars_map);
+			vp += len;
+			*vp++ = '\0';
+			goto varsdone;
+		}
+	}
+#endif

	/* We want internal/wltest driver to come up with default sromvars so we can
	 * program a blank SPROM/OTP.
@@ -4470,8 +4488,12 @@
	if (base && (base != mfgsromvars))
 #else
	if (base)
-#endif
+#endif
+#if (defined(STB) && defined(BCMEXTNVM))
+		;
+#else
		MFREE(osh, base, MAXSZ_NVRAM_VARS);
+#endif

	MFREE(osh, srom, SROM_MAX);
	return err;
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/bcmsromio.c aard37rc14_rel_6_37_4_8_PCIe/src/shared/bcmsromio.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/bcmsromio.c	1969-12-31 19:00:00.000000000 -0500
+++ aard37rc14_rel_6_37_4_8_PCIe/src/shared/bcmsromio.c	2014-05-13 11:04:00.874137139 -0400
@@ -0,0 +1,53 @@
+#ifdef WLC_LOW
+#ifndef LINUX_VERSION_CODE
+#include <linuxver.h>
+#endif
+
+#define MAX_SROM_FILE_SIZE SROM_MAX
+
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,0)
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/module.h>
+#include <osl.h>
+#include <linux/fs.h>
+#include <linux/vmalloc.h>
+#include <linux/mm.h>
+#include <linux/slab.h>
+#include <linux/unistd.h>
+#include <linux/fcntl.h>
+#include <asm/uaccess.h>
+#include <typedefs.h>
+#include <bcmdevs.h>
+#include "bcmsrom_fmt.h"
+#include "siutils.h"
+#include "bcmutils.h"
+
+int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes);
+
+int BCMATTACHFN(init_sromvars_map)(si_t *sih, uint chipId, void *buf, uint nbytes)
+{
+	void *fp = NULL;
+	char fname[32];
+	int ret = 0;
+
+	sprintf(fname, "/etc/wlan/bcm%x_vars.bin", chipId);
+
+	fp = (void*)osl_os_open_image(fname);
+	if (fp != NULL) {
+		while (osl_os_get_image_block(buf, nbytes, fp));
+		osl_os_close_image(fp);
+	}
+	else {
+		printk("Could not open %s file\n", fname);
+		ret = -1;
+	}
+
+	return ret;
+}
+#else
+/* no longer maintained for linux 2.4, compare above */
+#error "kernel version not supported"
+
+#endif /* LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,0) */
+#endif /* WLC_LOW */
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/dbus.c aard37rc14_rel_6_37_4_8_PCIe/src/shared/dbus.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/dbus.c	2013-10-21 20:41:24.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/shared/dbus.c	2014-05-13 11:04:00.874137139 -0400
@@ -44,6 +44,9 @@
 #include <linux/usb.h>
 #endif /* EHCI_FASTPATH_TX || EHCI_FASTPATH_RX */

+#include <linux/vmalloc.h>
+#define VMALLOC(osh, size)  vmalloc(size)
+#define VFREE(osh, addr, size)  vfree(addr)

 #if defined(BCM_DNGL_EMBEDIMAGE)
 /* zlib file format field ids etc from gzio.c */
@@ -706,8 +709,9 @@
			nvram_words_pad = 4 - dbus_info->nvram_len % 4;

		len = actual_fwlen + dbus_info->nvram_len + nvram_words_pad;
-#ifdef USBAP
+#if 1
		/* Allocate virtual memory otherwise it might fail on embedded systems */
+		DBUSERR(("%s() Allocating Virtual memory of size %d \n", __FUNCTION__, len));
		dbus_info->image = VMALLOC(dbus_info->pub.osh, len);
 #else
		dbus_info->image = MALLOC(dbus_info->pub.osh, len);
@@ -854,7 +858,7 @@
		err = DBUS_ERR;

	if (dbus_info->nvram) {
-#ifdef USBAP
+#if 1
		VFREE(dbus_info->pub.osh, dbus_info->image, dbus_info->image_len);
 #else
		MFREE(dbus_info->pub.osh, dbus_info->image, dbus_info->image_len);
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/dbus_usb_linux.c aard37rc14_rel_6_37_4_8_PCIe/src/shared/dbus_usb_linux.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/dbus_usb_linux.c	2013-10-21 20:41:25.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/shared/dbus_usb_linux.c	2014-05-13 11:04:00.874137139 -0400
@@ -3827,6 +3827,9 @@
		case BCM43242_CHIP_ID:
			strcat(fw_name, "43242");
			break;
+		case BCM43238_CHIP_ID:
+			strcat(fw_name, "43238");
+			break;
		case BCM43526_CHIP_ID:
			strcat(fw_name, "43526");
			break;
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/siutils.c aard37rc14_rel_6_37_4_8_PCIe/src/shared/siutils.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/shared/siutils.c	2013-10-21 20:41:24.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/shared/siutils.c	2014-05-13 11:04:00.878137547 -0400
@@ -1480,6 +1480,9 @@
 #endif
	nvram_exit((void *)si_local); /* free up nvram buffers */
 #endif /* !BCMDONGLEHOST  & STA */
+#if !defined(BCMHIGHSDIO)
+	nvram_exit((void *)sih);
+#endif

 #if !defined(BCMDONGLEHOST)
	if (BUSTYPE(sih->bustype) == PCI_BUS) {
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/usbdev/usbdl/Makefile aard37rc14_rel_6_37_4_8_PCIe/src/usbdev/usbdl/Makefile
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/usbdev/usbdl/Makefile	2013-10-21 20:41:29.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/usbdev/usbdl/Makefile	2014-05-13 11:04:00.878137547 -0400
@@ -18,7 +18,7 @@

 vpath %.c $(SRCBASE)/shared

-CFLAGS= -Wall -Wstrict-prototypes -g -O2 -I$(SRCBASE)/include -I$(SRCBASE)/common/include -I$(SRCBASE)/shared/zlib -DBCMTRXV2 -DUNRELEASEDCHIP
+CFLAGS= -Wall -Wstrict-prototypes -g -O2 -I$(SRCBASE)/include -I$(SRCBASE)/common/include -I$(SRCBASE)/shared/zlib -DBCMTRXV2 -DUNRELEASEDCHIP -fPIC

 LIBS = -lusb
 TARGET = $(OBJDIR)bcmdl
@@ -36,29 +36,24 @@
	CLEAN = clean_linux
	CFLAGS += -I../libusb
	LDFLAGS += $(CROSS_LD_PATH)
-endif
-
+else
 ifeq ($(TARGETENV), linuxmips_be)
	OBJECTS += $(OBJDIR)usb_linux.o
	COMPILE = mips-linux-gcc
-	LIBS := -L$(LIBUSB_PATH)/.libs $(LIBUSB_PATH)/.libs/libusb.a
-	CFLAGS += -I$(LIBUSB_PATH) -DIL_BIGENDIAN
-endif
-
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include -DIL_BIGENDIAN
+else
 ifeq ($(TARGETENV), linuxmips)
	TARGET_PREFIX := mipsel-linux-
	OBJECTS += $(OBJDIR)usb_linux.o
-	CFLAGS += -I ../libusb
	COMPILE = mipsel-linux-gcc
	CLEAN = clean_linux
-	LDFLAGS += -L$(LIBUSB_PATH)/.libs
-	LIBS= ../libusb/.libs/libusb.a
-	LIBS := -L$(LIBUSB_PATH)/.libs $(LIBUSB_PATH)/.libs/libusb.a
-	CFLAGS += -I$(LIBUSB_PATH)
+	LDFLAGS += -L$(LIBUSB_PATH)/lib
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include
 install:
	cp bcmdl $(SRCBASE)/router/mipsel-uclibc/target/bin
-endif
-
+else
 ifeq ($(TARGETENV), linux26mips)
	TARGET_PREFIX := mipsel-uclibc-linux26-
	TARGET := bcmdlmips26
@@ -69,13 +64,30 @@
	LDFLAGS += -L /projects/hnd/tools/linux/lib/mips26
 install:
	cp bcmdl $(SRCBASE)/router/mipsel-uclibc/target/bin
-endif
-
+else
 ifeq ($(TARGETENV), macos)
	TARGET = bcmdl_macos
	CLEAN = clean_macos
	COMPILE = xcodebuild
	PROJECT = bcmdl.xcodeproj
+else
+ifeq ($(TARGETENV), linuxarm_le)
+	TARGET_PREFIX := arm-linux-
+	OBJECTS += $(OBJDIR)usb_linux.o
+	COMPILE = arm-linux-gcc
+	CLEAN = clean_linux
+	LDFLAGS += -L$(LIBUSB_PATH)/lib
+	LIBS := -L$(LIBUSB_PATH)/lib $(LIBUSB_PATH)/lib/libusb.a
+	CFLAGS += -I$(LIBUSB_PATH)/include
+install:
+	cp bcmdl $(SRCBASE)/router/armel-uclibc/target/bin
+else
+	$(error TARGETENV $(TARGETENV) is not defined)
+endif
+endif
+endif
+endif
+endif
 endif

 ifeq ($(BCMQT),1)
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wlconfig_lx_wl_armle aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wlconfig_lx_wl_armle
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wlconfig_lx_wl_armle	1969-12-31 19:00:00.000000000 -0500
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wlconfig_lx_wl_armle	2014-05-13 11:04:00.878137547 -0400
@@ -0,0 +1,32 @@
+# Broadcom 802.11abg Networking Device Driver Configuration file for STB linux
+#
+# Copyright (C) 2012, Broadcom Corporation. All Rights Reserved.
+#
+# Permission to use, copy, modify, and/or distribute this software for any
+# purpose with or without fee is hereby granted, provided that the above
+# copyright notice and this permission notice appear in all copies.
+#
+# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
+# SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
+# OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
+# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+#
+# $Id: wlconfig_lx_wl_mips,v 1.4 2010-02-18 22:45:21 $
+#
+# src/wl/linux driver config file
+
+#include $(WLCFGDIR)/wlconfig_lx_wl_apdef
+#include $(WLCFGDIR)/wlconfig_lx_wl_stadef
+
+#BCMSUP_PSK=1
+NVRAMSTUBS=1
+WLLXIW=0
+STBLINUX=1
+
+#include $(WLCFGDIR)/wl.mk
+#all:
+#	@echo "WLFLAGS = $(WLFLAGS)"
+#	@echo "WLFILES = $(WLFILES)"
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wlconfig_lx_wl_media aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wlconfig_lx_wl_media
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wlconfig_lx_wl_media	2013-10-21 20:41:09.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wlconfig_lx_wl_media	2014-05-13 11:04:00.878137547 -0400
@@ -37,7 +37,9 @@
 EXTENDED_VID_PID={ USB_DEVICE(0x0846, 0x9011) }, \
                  { USB_DEVICE(0x050d, 0xd321) }, \
                  { USB_DEVICE(0x1eda, 0x0bdc) }, \
-                 { USB_DEVICE(0x043E, 0x3001) }
+                 { USB_DEVICE(0x043E, 0x3001) }, \
+                 { USB_DEVICE(0x0471, 0x20E7) }, \
+                 { USB_DEVICE(0x13b1, 0x003a) }
 SEQ_CMDS=0
 ifeq ($(BCM_STA_CFG80211),1)
 WOWL=0
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wl.mk aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wl.mk
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/config/wl.mk	2013-10-21 20:41:09.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wl/config/wl.mk	2014-05-13 11:04:00.878137547 -0400
@@ -1498,6 +1498,21 @@
 endif
 #endif

+ifeq ($(STBLINUX),1)
+	WLFLAGS += -DSTB
+	ifeq ($(BCMEXTNVM),1)
+		WLFLAGS += -DBCMEXTNVM -DBCM47XX
+		WLFILES_SRC_LO += src/shared/bcmsromio.c
+		VARCFILES_SRC += src/shared/bcm4360_vars.c
+	endif
+endif
+ifeq ($(STBLINUX),1)
+	WLFLAGS += -DSTB
+	ifeq ($(BCMEXTNVM),1)
+		WLFLAGS += -DBCMEXTNVM -DBCM47XX
+		WLFILES_SRC_LO += src/shared/bcmsromio.c
+	endif
+endif

 #ifndef LINUX_HYBRID
 # AP/ROUTER with SDSTD
@@ -2130,6 +2145,7 @@
 # Legacy WLFILES pathless definition, please use new src relative path
 # in make files.
 WLFILES := $(sort $(notdir $(WLFILES_SRC)))
+VARCFILES := $(sort $(notdir $(VARCFILES_SRC)))

 ifeq ($(AMPDU_HOSTREORDER), 1)
	WLFLAGS += -DBRCMAPIVTW=128 -DWLAMPDU_HOSTREORDER
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/linux/Makefile aard37rc14_rel_6_37_4_8_PCIe/src/wl/linux/Makefile
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wl/linux/Makefile	2013-10-21 20:41:32.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wl/linux/Makefile	2014-05-13 11:04:00.878137547 -0400
@@ -141,7 +141,7 @@
 default all:
	@echo "Using default target(s) $(DEFTARGETS)"
	+$(MAKE) EXPANDED=true TARGETS="$(DEFTARGETS)" $(DEFTARGETS)
-native mipsel mipseb arm:
+native mipsel mipseb arm arm_le:
	@echo "Using default target(s) for $@ architecture"
	+$(MAKE) EXPANDED=true TARGETS="$(subst native,$@,$(DEFTARGETS))" \
		$(subst native,$@,$(DEFTARGETS))
@@ -282,6 +282,10 @@

 DFLAGS += -DSRCBASE=\"$(SRCBASE)\" -DBCMDRIVER

+ifneq ($(filter arm,$(TARGETARCH)),)
+DFLAGS += -D__LINUX_ARM_ARCH__=7 -march=armv7-a
+endif
+
 ifneq ($(findstring comp,$(TARGET)),)
    DFLAGS += -DBCMUSBDEV_COMPOSITE
 endif
@@ -296,6 +300,10 @@
 IFLAGS += -I$(LINUXDIR_INC_BASE)/include
 IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated
 ifeq ($(STBLINUX),1)
+ifeq ($(call KERNEL_GE,3.8.0),TRUE)
+  IFLAGS += -I$(LINUXDIR)/include/uapi
+  IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated
+endif
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-brcmstb
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-generic
 else
@@ -304,6 +312,10 @@
   IFLAGS += -I$(LINUXDIR_INC_BASE)/include/asm/mach-default
 endif
 IFLAGS   += -I.
+ifeq ($(call KERNEL_GE,3.7.0),TRUE)
+  IFLAGS += -I$(LINUXDIR)/include/uapi
+  IFLAGS += -include $(LINUXDIR)/include/linux/kconfig.h
+endif

 IFLAGS   += -I$(SRCBASE)/wl/sys
 IFLAGS   += -I$(SRCBASE)/wl/phy
@@ -313,6 +325,9 @@
 IFLAGS   += -I$(SRCBASE)/shared
 IFLAGS   += -I$(SRCBASE)/shared/zlib

+IFLAGS += -I$(LINUXDIR_INC_BASE)/include/generated/
+IFLAGS += -I$(LINUXDIR_INC_BASE)/mach-brcmstb/include/
+
 ############################################################
 # Check if the dongle image is embedded
 ############################################################
@@ -380,7 +395,8 @@
   endif # dnglimage
 endif # high

-WFLAGS := -Wall -Wstrict-prototypes -Werror # -Wpointer-arith
+#WFLAGS := -Wall -Wstrict-prototypes -Werror # -Wpointer-arith
+WFLAGS := -Wall -Wstrict-prototypes -Werror -Wno-unused-local-typedefs -Wno-unused-variable -Wno-unused-function -Wno-unused-but-set-variable

 #disabled# # Kernel starting from fc15 need a gcc 4.6.+ compiler that is more stricter
 #disabled# # and doesn't allow warnings pass compilation step.
@@ -539,9 +555,9 @@
   ifneq ($(filter debug,$(INMAKE)),)
     DEBUG=1
   endif
-  ifeq ($(filter mipsel,$(INMAKE)),)
-    WLLXNOMIPSEL=1
-  endif
+  #ifeq ($(filter mipsel,$(INMAKE)),)
+  #  WLLXNOMIPSEL=1
+  #endif

   # Get remaining WL config, set flags and files
   include $(WLCONFFILE)
@@ -593,8 +609,10 @@
       endif
     endif
     ifneq ($(filter arm,$(INMAKE)),)
-      CROSS_COMPILE ?= armeb-linux-
-      DFLAGS += -DIL_BIGENDIAN
+### TGK...eh well, neither 'eb', nor -DIL_BIGENDIAN (see mips{el,eb})
+###      CROSS_COMPILE ?= armeb-linux-
+###      DFLAGS += -DIL_BIGENDIAN
+      CROSS_COMPILE ?= arm-linux-
       ifneq ($(filter nodebug,$(INMAKE)),)
         LDFLAGS += -S
       endif
@@ -618,6 +636,9 @@
     # except for __KERNEL__ !
     ifeq ($(findstring wluser,$(TARGET)),)
       CFLAGS += -D__KERNEL__
+      ifneq ($(filter arm,$(INMAKE)),)
+         CFLAGS += -D__LINUX_ARM_ARCH__=7
+      endif
     endif
     # we need to export this so the make from the kernel can know it
     WLCFLAGS = $(CFLAGS) -I$(shell pwd)
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/include/wps_api_osl.h aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/include/wps_api_osl.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/include/wps_api_osl.h	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/include/wps_api_osl.h	2014-05-13 11:04:00.878137547 -0400
@@ -61,7 +61,7 @@
 extern char *wps_osl_get_short_adapter_name();
 extern int wps_osl_get_mac(uint8 *mac);
 extern char *wps_osl_get_ssid();
-extern uint32 wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id);
+extern uint32 wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id);
 extern void wps_osl_deinit();
 extern void wps_osl_abort();
 extern uint32 wps_osl_setup_802_1x(uint8 *bssid);
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/include/wps_sdk.h aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/include/wps_sdk.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/include/wps_sdk.h	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/include/wps_sdk.h	2014-05-13 11:04:00.882137955 -0400
@@ -276,6 +276,8 @@
  * Function : wps_api_open
  * Parameters :
  *		adapter_id - Adapter identifier
+ *		bridge_id Bridge adaptor name that the interface is connected too (the interface to
+ *		listen for events on)
  *		cb_ctx  - Optional. If provided, the WPS status callback
  *			will be called with this context.
  *		callback - WPS status callback.
@@ -302,10 +304,10 @@
  *			serial Number = "5678"
  */
 #ifdef WFA_WPS_20_TESTBED
-BCM_WPSAPI bool wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback,
+BCM_WPSAPI bool wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback,
	wps_devinf *devinf, wps20_testbed_inf *wps20_tbinf, bool ap_pin, bool version2);
 #else
-BCM_WPSAPI bool wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback,
+BCM_WPSAPI bool wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback,
	wps_devinf *devinf, bool ap_pin, bool version2);
 #endif

diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_api.c aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_api.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_api.c	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_api.c	2014-05-13 11:04:00.882137955 -0400
@@ -732,10 +732,10 @@
 /* wps_api_open function must be called first, before any other wps api call */
 BCM_WPSAPI bool
 #ifdef WFA_WPS_20_TESTBED
-wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
+wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
	wps20_testbed_inf *wps20_tbinf, bool ap_pin, bool b_v2)
 #else
-wps_api_open(const char *adapter_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
+wps_api_open(const char *adapter_id, const char* bridge_id, void *cb_ctx, fnWpsProcessCB callback, wps_devinf *devinf,
	bool ap_pin, bool b_v2)
 #endif /* WFA_WPS_20_TESTBED */
 {
@@ -794,7 +794,7 @@
	wps_api_status_cb(&wps_api_wksp->cb, wps_api_wksp->cb_ctx, WPS_STATUS_INIT, NULL);

	/* WPS hook init for adapter and led (HW) */
-	if (wps_hook_init(cb_ctx, callback, adapter_id) == false) {
+	if (wps_hook_init(cb_ctx, callback, adapter_id, bridge_id) == false) {
		TUTRACE((TUTRACE_ERR, "wps_api_open : Failed to initial wireless adapter.\n"));
		return false;
	}
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_api_priv.h aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_api_priv.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_api_priv.h	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_api_priv.h	2014-05-13 11:04:00.882137955 -0400
@@ -35,7 +35,7 @@

 extern bool wps_hook_create_profile(const struct _wps_credentials *credentials);
 extern int wps_hook_get_mac(uint8 *mac);
-extern bool wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id);
+extern bool wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id);
 extern void wps_hook_deinit();
 extern void wps_hook_abort();
 extern uint32 wps_hook_setup_802_1x(char *bssid);
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_hooks.c aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_hooks.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/common/wps_hooks.c	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/common/wps_hooks.c	2014-05-13 11:04:00.882137955 -0400
@@ -61,9 +61,9 @@

 /* Initial HW related */
 bool
-wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id)
+wps_hook_init(void *cb_ctx, void *cb, const char *adapter_id, const char * bridge_id)
 {
-	uint32 retVal = wps_osl_init(cb_ctx, cb, adapter_id);
+	uint32 retVal = wps_osl_init(cb_ctx, cb, adapter_id, bridge_id);
	return ((retVal == WPS_OSL_SUCCESS) ? true : false);
 }

diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/Makefile aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/Makefile
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/Makefile	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/Makefile	2014-05-13 11:04:00.882137955 -0400
@@ -45,7 +45,7 @@
 WFA_TB ?= 0

 # Set CFLAGS
-CFLAGS = -Wall -Werror -Wnested-externs -fPIC -fno-strict-aliasing
+CFLAGS = -Wall -Werror -Wnested-externs -fPIC -fno-strict-aliasing -Wno-unused-but-set-variable
 ifeq ($(BLDTYPE),debug)
	CFLAGS += -g -DDEBUG
	# Mark mips compiler to produce debugging information that is understood by gdb
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_tester.c aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_tester.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_tester.c	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_tester.c	2014-05-13 11:04:00.882137955 -0400
@@ -343,11 +343,11 @@

	/* 2. Open WPS */
 #ifdef WFA_WPS_20_TESTBED
-	bRet = wps_api_open(STRP(wps->ifname), NULL, _wps_join_callback,
+	bRet = wps_api_open(STRP(wps->ifname), STRP(wps->brname), NULL, _wps_join_callback,
		_wps_my_devinf(&my_devinf, wps->transport_uuid), &wps->wps20_tbinf, wps->b_appin,
		wps->b_v2);
 #else
-	bRet = wps_api_open(STRP(wps->ifname), NULL, _wps_join_callback,
+	bRet = wps_api_open(STRP(wps->ifname), STRP(wps->brname), NULL, _wps_join_callback,
		_wps_my_devinf(&my_devinf, wps->transport_uuid), wps->b_appin, wps->b_v2);
 #endif
	if (bRet == FALSE) {
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_tester.h aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_tester.h
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_tester.h	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_tester.h	2014-05-13 11:04:00.882137955 -0400
@@ -29,7 +29,8 @@

	char bssid[6];
	char ssid[33];
-	char ifname[16];
+    char ifname[16];
+    char brname[16];
	char def_dhclient_pf[256];
	char ip_addr[16];
	char dhcp_cmd[256];
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_ui.c aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_ui.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_api_ui.c	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_api_ui.c	2014-05-13 11:04:00.882137955 -0400
@@ -968,11 +968,16 @@
			wps->b_ssid = TRUE;
			WPS_PRINT(("SSID : %s", wps->ssid));
		}
-		else if (!strcmp(cmd, "-if")) {
-			WPS_ARGC_CHECK();
-			val = argv[index++]; argc--;
-			wps_strncpy(wps->ifname, val, sizeof(wps->ifname));
-		}
+        else if (!strcmp(cmd, "-if")) {
+            WPS_ARGC_CHECK();
+            val = argv[index++]; argc--;
+            wps_strncpy(wps->ifname, val, sizeof(wps->ifname));
+        }
+        else if (!strcmp(cmd, "-br")) {
+            WPS_ARGC_CHECK();
+            val = argv[index++]; argc--;
+            wps_strncpy(wps->brname, val, sizeof(wps->brname));
+        }
		else if (!strcmp(cmd, "-bssid")) {
			WPS_ARGC_CHECK();
			/*
diff -BNru aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_linux_osl.c aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_linux_osl.c
--- aard37rc14_rel_6_37_4_8_PCIe_org/src/wps/wpsapi/linux/wps_linux_osl.c	2013-10-21 20:41:34.000000000 -0400
+++ aard37rc14_rel_6_37_4_8_PCIe/src/wps/wpsapi/linux/wps_linux_osl.c	2014-05-13 11:04:00.882137955 -0400
@@ -93,6 +93,8 @@
 WPS_OSL_T *wps_osl_wksp = NULL;

 static char ifname_lx[IFNAMSIZ] = "";
+static char ifname_br[IFNAMSIZ] = "";
+
 static uint8 peer_mac[6] = {0};
 static int eap_fd = -1; /* descriptor to raw socket  */
 static int ifindex = -1; /* interface index */
@@ -158,6 +160,12 @@

	ifr.ifr_name[0] = '\0';

+	if (ifname_br[0] != '\0')
+    {
+	    strncpy(ifname, ifname_br, ifname_len);
+	    return 0;
+    }
+
	if (!(fp = fopen(proc_net_dev, "r")))
		return ret;

@@ -630,7 +638,7 @@
		memcpy(peer_mac, bssid, 6);

	memset(&ifr, 0, sizeof(ifr));
-	wps_strncpy(ifr.ifr_name, ifname_lx, sizeof(ifr.ifr_name));
+	wps_strncpy(ifr.ifr_name, ifname_br[0] ? ifname_br : ifname_lx, sizeof(ifr.ifr_name));

	err = ioctl(eap_fd, SIOCGIFINDEX, &ifr);
	if (err < 0) {
@@ -644,15 +652,24 @@

	ll.sll_family = PF_PACKET;
	ll.sll_ifindex = ifr.ifr_ifindex;
-	ifindex  = ifr.ifr_ifindex;
	ll.sll_protocol = htons(ETH_8021X_PROT);
	if (bind(eap_fd, (struct sockaddr *) &ll, sizeof(ll)) < 0) {
-		WPS_DEBUG(("Bind interface failed\n"));
+		WPS_DEBUG(( "Bind interface failed\n"));
		close(eap_fd);
		eap_fd = -1;
		return WPS_OSL_ERROR;
	}

+	wps_strncpy(ifr.ifr_name, ifname_lx, sizeof(ifr.ifr_name));
+	err = ioctl(eap_fd, SIOCGIFINDEX, &ifr);
+	if (err < 0) {
+		WPS_DEBUG(( "Get interface index failed\n"));
+		close(eap_fd);
+		eap_fd = -1;
+		return WPS_OSL_ERROR;
+	}
+	ifindex  = ifr.ifr_ifindex;
+
	return WPS_OSL_SUCCESS;
 }

@@ -840,7 +857,7 @@
 }

 uint32
-wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id)
+wps_osl_init(void *cb_ctx, void *cb, const char *adapter_id, const char* bridge_id)
 {
	char *ifname = (char*) adapter_id;
	char dyn_name[IFNAMSIZ];
@@ -869,6 +886,11 @@
		ifname = dyn_name;
	}

+	if (bridge_id != NULL)
+	{
+	    wps_strncpy(ifname_br, bridge_id, sizeof(ifname_br));
+	}
+
	/* Save this specific interface for further use */
	wps_strncpy(ifname_lx, ifname, sizeof(ifname_lx));

@@ -925,6 +947,8 @@
		free(wps_osl_wksp);
		wps_osl_wksp = NULL;
	}
+    memset(ifname_br, 0, sizeof(ifname_br));
+    memset(ifname_lx, 0, sizeof(ifname_lx));
 }

 void
