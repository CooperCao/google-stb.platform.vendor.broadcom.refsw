#!/bin/sh -e

# Kickoff CD generator for Fedora 11
# 	$Id$	

# Kickoff CDs can be used to reinstall the OS.  If upgrading from an
# earlier version of Linux kickoff will try to retain essential system
# configuation, but it's a good idea to run prekickoff first, to
# provide a backup of that information.

dist=/projects/hnd_cdroms/os/Linux/Fedora/Fedora11/i386
tmp=/tmp/iso

# Convert path into NFS components
mountinfo=`df -Pk $dist|tail -1`
server=`expr "$mountinfo" : '\(.*\):'`
filesystem=`expr "$mountinfo" : '.*:\([^ ]*\)'`
mountpoint=`expr "$mountinfo" : '.* \([^ ]*\)$'`
dir=${dist/#$mountpoint/$filesystem}

echo "Archive $server:$dir"

rm -rf $tmp
mkdir $tmp

cp -r $dist/isolinux/ $tmp
cd $tmp
chmod u+w isolinux/*
sed '
s/timeout 600/timeout 20/
s/append/append ks=cdrom:\/ks.cfg/' \
    isolinux/isolinux.cfg > isolinux/isolinux.cfg.tmp
mv isolinux/isolinux.cfg.tmp isolinux/isolinux.cfg

cat >isolinux/ks.cfg <<'EOF'
# Kickstart file generated by $0
#platform=x86, AMD64, or Intel EM64T
#version=F11
# Firewall configuration
firewall --disabled
# Install OS instead of upgrade
install
# Root password
rootpw --iscrypted $1$2619lNbE$OICBEH3Q7VFq/kTA6jk5O0
# Network information
network  --bootproto=dhcp --device=eth0 --onboot=on
# System authorization information
auth  --useshadow  --passalgo=md5 --enablenis --nisdomain=sanjose
# Use graphical install
#graphical
firstboot --disable
# Configure X but don't start it up by default, since it's not
# generally useful on a DUT
#xconfig --defaultdesktop gnome
skipx
# System keyboard
keyboard us
# System language
lang en_US
# SELinux configuration
selinux --disabled
# Installation logging level
logging --level=info
# Use NFS installation media
EOF
cat >>isolinux/ks.cfg <<EOF
nfs --server=$server --dir=$dir
EOF
cat >>isolinux/ks.cfg <<'EOF'
# System timezone
timezone --isUtc America/Los_Angeles
# System bootloader configuration
bootloader --location=mbr --driveorder="sda"
# Partition clearing information
clearpart --all --initlabel
part / --fstype="ext3" --grow --size=8000
#part swap --fstype="swap" --recommended

%pre --log=/tmp/kickoff-pre.log
#!/bin/sh -x
exec >/tmp/kickoff-pre.log 2>&1
set -x

mkdir /mnt/a
mkdir /tmp/preserve

while read major minor blocks name rest; do
    case "$name" in
        '') ;;
        name) ;;
        loop*) ;;
        *) 
	mknod /tmp/dev_$name b $major $minor
	if mount /tmp/dev_$name /mnt/a 2>/dev/null && cd /mnt/a; then
            # Note - if multiple linux images exist we may get duplicates

            # Preserve file left by prekickoff
            if [ -f boot/preserve.tar ]; then
 		cp boot/preserve.tar /tmp/preserve.tar
	    elif [ -f preserve.tar ]; then
		cp preserve.tar /tmp/preserve.tar
	    elif [ -s /tmp/preserve.tar ]; then
		# Don't overwrite if we already found one
		:
	    else 
		# Try to preserve now
	    	cp -p etc/inittab etc/inittab.preupgrade
	    	tar -cf /tmp/preserve.tar \
       		   etc/ssh/*key* \
		   root/.ssh/* \
		   var/spool/cron/* \
		   etc/sysconfig/network-scripts/ifcfg-eth* \
		   etc/sysconfig/network etc/event.d/consolelogger* \
		   etc/dhcpd.conf \
		   etc/dhcp/dhcpd.conf \
		   etc/yp.conf \
		   etc/inittab.preupgrade 
	    fi
	    cd /
	    umount /mnt/a
	fi
	rm /tmp/dev_$name
        ;;
    esac
done < /proc/partitions
rmdir /mnt/a 2>/dev/null

exit 0

%end

%post --nochroot --log=/mnt/sysimage/root/kickoff-post1.log
#!/bin/sh -x
set -x
# Copy log files to disk
cp /tmp/*.log /mnt/sysimage/root

# Unpack preserved files
tar -xvf /tmp/preserve.tar -C /mnt/sysimage

%end

%post --log=root/kickoff-post2.log
set -x 
yum -y install \
    autofs \
    crash \
    expect \
    tftp \
    tcl \
    hping3 \
    gnuplot \
    dhcp


cat >> /etc/sysctl.conf <<EOF2
# Reboot on panic
kernel.panic = 1
kernel.panic_on_oops = 1

# Prevent TCP slow-start
net.ipv4.tcp_congestion_control = bic
EOF2

cat >> /etc/modprobe.d/blacklist.conf <<EOF3

# BCM
blacklist b43
blacklist b43legacy
blacklist b44
blacklist ssb
blacklist sdhci
blacklist sdhci_pci
blacklist mmc_core
blacklist bcm43xx_mac80211
EOF3

# Remove daily root messages
rm -f /etc/cron.daily/0logwatch

chkconfig NetworkManager off
chkconfig network on
chkconfig sendmail off
chkconfig ntpd on

# Configure NTP
echo "server 10.10.32.12" >> /etc/ntp.conf

# WAR for FC11 ypbind bug when NetworkManager isn't installed
echo 'OTHER_YPBIND_OPTS="-no-dbus"' > /etc/sysconfig/ypbind

# If we used a USB NIC for the install, remove the persistent reference
sed -i '/^# USB/{N;d}' /etc/udev/rules.d/70-persistent-net.rules

# Clear out the DHCP hostname
sed -i '/HOSTNAME=dhcp/d' /etc/sysconfig/network

# Disable GUI
sed -i 's/^id:5:/id:3:/' /etc/inittab
sed -i 's/ rhgb / /' /etc/grub.conf

# If there's no gateway, take the one from eth0
egrep GATEWAY /etc/sysconfig/network || \
    egrep GATEWAY /etc/sysconfig/network-scripts/ifcfg-eth0 >> /etc/sysconfig/network

%end

%packages

@admin-tools
@base
@base-x
@core
@development-libs
@development-tools
@dial-up
@editors
@gnome-desktop
@graphical-internet
@graphics
@hardware-support
@legacy-network-server
@system-tools
@text-internet
emacs
gdm
tcsh

%end

EOF

mkisofs -o file.iso -b isolinux.bin -c boot.cat -no-emul-boot \
    -boot-load-size 4 -boot-info-table -R -J -v -T isolinux/

echo 
echo "Please write /tmp/iso/file.iso to a CD"
if [ -x /usr/bin/nautilus-cd-burner ]; then
    /usr/bin/nautilus-cd-burner --source-iso=/tmp/iso/file.iso &
else
    brasero -i /tmp/iso/file.iso
fi
exit
