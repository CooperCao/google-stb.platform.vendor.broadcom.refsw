#!/bin/env utf
# -*-tcl-*-
#
# SWWLAN-42875 - UTF: 43451b1 MQ ERROR wlc_bmac_flush_tx_fifos:
# suspend dma 0 not done after 80000 us: chnstatus 0x0008 txfl_bmap
# 0x0000 txefs 0x0000
# Test approach is to set up a tx traffic background then rapidly
# scan.
#
# $Id$
# $Copyright Broadcom Corporation$
#

package require UTF
package require UTF::Streams
package require UTF::Test::ConnectAPSTA

UTF::Test SWWLAN-42875 {AP STA args} {
    UTF::Getopts {
	{loop.arg 500 "Loop count"}
    }
    UTF::Record "Setup" {
	# Kill off any stale iperf servers - if we kill off daemons
	# it's ok, they'll get restarted.
	catch {[$AP lan] pkill -TERM iperf}
	catch {$STA pkill -TERM iperf}
	if {[catch {$STA ping $AP}]} {
	    ConnectAPSTA $AP $STA -security open -chanspec 36
	}
	UTF::stream logginglevel ANALYZE; # Not interested in data
	UTF::stream create T -tx $STA -rx $AP -protocol tcp -reportinterval 10
	UTF::stream allstreams start
    }

    set earlyabort 1; # Flag for early abort of the outer loop
    # Report in batches of 100 to keep the log files reasonable
    for {set i 0} {$i < $(loop) && $earlyabort} {incr i 10} {
	UTF::Try "loop $i" {
	    for {set j 0} {$j < 10} {incr j} {
		UTF::Message INFO $STA "loop [expr {$i + $j}]"
		set earlyabort 0
		catch {$STA wl scan}
		UTF::Sleep 3
		#$STA wl_escanresults
		set earlyabort 1
	    }
	}
    }
    UTF::Record "Cleanup" {
	UTF::stream exitstreams
    }
}
