#!/bin/env utf
# -*-tcl-*-

# UTF script for testing multiple shared authentication connections.

# $Id$
#
# APSTAS is an even-length list of AP and STA objects: AP1 STA1 AP2 STA2 ...
# WAN is a reference host on the Wan

package require UTF
package require UTF::Test::ConnectAPSTA
package require UTF::Test::Mbss::APAddInterface
package require UTF::Test::Mbss::Connectivity

package provide UTF::Test::Mbss::MultiShared 2.0

UTF::Test Mbss::MultiShared {APSTAS} {
    foreach {AP STA} $APSTAS {
	catch {$STA wl disassoc}
	APAddInterface -lan $AP
	UTF::Test::APConfigureSecurity $AP -security shared
    }
    foreach {AP STA} $APSTAS {
	UTF::Try "MultiShared associate $STA to $AP" {
	    UTF::Test::ConnectAPSTA $AP $STA
	    lappend ends $STA
	    return
	}
    }
    if {[info exists ends]} {
	# If we connected, then test it, otherwise allow failure to
	# propagate
	set fw [string is false [$AP nvram get fw_disable]]
	Connectivity $ends {} [$AP wan] -firewall $fw
    }
}
