#!/bin/env utf
# -*-tcl-*-

# UTF test script for testing the moving of interfaces between bridges
# on a router

# $Id: 759ca9724abf3274fc3f7bcdb2756be7f1690f87 $
#
# Usage: ParallelConnect APSTAS LAN WAN
#
# APSTAS is an even-length list of AP and STA objects: AP1 STA1 AP2 STA2 ...
# LAN is a reference host on the Lan
# WAN is a reference host on the Wan

# During the test the APs will be assigned to bridges and each
# STA will be connected to it's corresponding AP, with various
# security settings.  Once all STAs are associated, both positive and
# negative connectivity will be verified.

package require UTF
package require UTF::Test::Mbss::APAddInterface
package require UTF::Test::Mbss::Connectivity
package require UTF::Test::ConnectAPSTA

package provide UTF::Test::Mbss::ParallelConnect 2.0

UTF::Test Mbss::ParallelConnect {APSTAS} {

    if {[llength $APSTAS] % 2} {
	error "Odd number of APSTA arguments\n"
    }

    set i 0
    set LANS {}
    set LAN1S {}
    foreach {AP STA} $APSTAS {

	# Alternate bridges
	# BSD supports both bridges, but the firewall doesn't work so
	# all the connectivity tests will fail. PR#72421
	if {$i > 1 && ![$AP hostis Vx BSDAP]} {
	    APAddInterface -lan1 $AP
	    lappend LAN1S $STA
	} else {
	    APAddInterface -lan $AP
	    lappend LANS $STA

	}
	incr i
    }

    set WAN [$AP wan]
    set LAN [$AP lan]

    lappend LANS $LAN

    UTF::Try "Disable firewall" {
	if {[string is false [$AP nvram get fw_disable]]} {
	    $AP restart fw_disable=1
	}
    }

    # Associate all STAs
    foreach {AP STA} $APSTAS {
	UTF::Test::ConnectAPSTA $AP $STA
    }

    Connectivity $LANS $LAN1S $WAN -firewall off

}
