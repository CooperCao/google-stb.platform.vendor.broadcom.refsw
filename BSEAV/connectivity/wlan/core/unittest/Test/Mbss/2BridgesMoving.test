#!/bin/env utf
# -*-tcl-*-

# UTF test script for testing the moving of interfaces between bridges
# on a router

# $Id: 07bf965f105eeb4b6224175799f77ae3c05a1dbf $
#
# Usage: 2BridgesMoving AP1 STA1 AP2 STA2 LAN WAN
#
# AP1 and AP2 are real or virtual interfaces on the same router.
# STA1 is associated to AP1
# STA2 is associated to AP2
# LAN is a reference host on the Lan
# WAN is a reference host on the Wan

# During the test AP1 and AP2 are moved between lan and lan1 without
# explicit reassociation.  DHCP leases are refreshed and both positive
# and negative connectivity verified as appropriate.

package require UTF
package require UTF::Test::Mbss::APAddInterface
package require UTF::Test::Mbss::Connectivity

package provide UTF::Test::Mbss::2BridgesMoving 2.0

UTF::Test Mbss::2BridgesMoving {AP1 STA1 AP2 STA2} {

    UTF::Assert [$AP1 cget -host] [$AP2 cget -host] $AP1 "Same Router"

    # Verify Reference hosts
    set LAN [$AP1 lan]
    set WAN [$AP1 wan]
    $LAN ping $WAN

    APAddInterface -lan $AP1 $AP2
    $STA1 ifconfig dhcp
    $STA2 ifconfig dhcp

    $STA1 ping $AP1
    $STA2 ping $AP2

    Connectivity [list $STA1 $STA2 $LAN] [list] $WAN -firewall off

    APAddInterface -lan1 $AP2
    $STA2 ifconfig dhcp

    $STA1 ping $AP1
    $STA2 ping $AP2

    Connectivity [list $STA1 $LAN] [list $STA2] $WAN -firewall off

    APAddInterface -lan1 $AP1
    $STA1 ifconfig dhcp

    $STA1 ping $AP1
    $STA2 ping $AP2

    Connectivity [list $LAN] [list $STA1 $STA2] $WAN -firewall off
}
