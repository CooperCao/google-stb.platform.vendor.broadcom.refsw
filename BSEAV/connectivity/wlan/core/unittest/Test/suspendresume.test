#!/bin/env utf
# -*-tcl-*-

# UTF test script for testing suspend/resume
#
#
# $Id$
# $Copyright Broadcom Corporation$
#

package require UTF
package require UTF::Multiperf
package require UTF::Test::ConnectAPSTA

package provide UTF::Test::suspendresume 2.0

UTF::Test suspendresume {AP STA args} {
    UTF::Getopts {
	{notraffic "Skip traffic test"}
    }
    if {![$STA hostis DHD]} {
	UTF::Message INFO $STA "skipping unsupported host type"
	return
    }
    UTF::Try "$STA: Suspend w/o assoc" {
	if {[$STA wl isup]} {
	    $STA wl disassoc
	}
	$STA -x rtcwake -m mem -s 5
	$STA wl ver
	return
    }
    UTF::Try "$STA Suspend w/assoc" {
	ConnectAPSTA $AP $STA -security aespsk2
	$STA -x rtcwake -m mem -s 5
	$STA ping $AP
    }
    if {!$(notraffic)} {
	UTF::Try "$STA Suspend w/traffic" {
	    ConnectAPSTA $AP $STA -security aespsk2
	    UTF::Multiperf [list $STA $AP] -i 2 -t 10 -callback {
		UTF::Sleep 2; $STA -x rtcwake -m mem -s 5
	    }
	    $STA ping $AP
	}
    }
}
