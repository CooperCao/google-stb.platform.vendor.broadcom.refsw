#!/bin/env utf
# -*-tcl-*-
#
# UTF test script for Wasting memory on a dongle.  Test stops either
# when mallocs start to fail, or when pings stop working.
# $Id: c2e440aac1c9496bd7cb8fe120c54e10793cd2e7 $
#

package require UTF
package require UTF::Test::ConnectAPSTA

UTF::Test MemoryWaste {AP STA args} {

    UTF::Getopts {
	{start.arg "44" "Increment"}
	{incr.arg "1" "Increment"}
    }

    $STA reload
    ConnectAPSTA $AP $STA
    $STA rte mu

    $STA ping $AP

    $STA rte "mw $(start)"

    for {set i $(start)} {$i < 1000} {incr i $(incr)} {
	UTF::Message INFO "" "Waste: $i"
	$STA rte "mw $(incr)"
	if {![regexp {Malloc failure count: (\d+)} [$STA rte mu] - count]} {
	    error "failure count not found"
	} elseif {$count} {
	    UTF::Message INFO "" "Malloc failed at $i"
	    break
	}
	if {[catch {$STA ping $AP}]} {
	    UTF::Message INFO "" "Ping failed at $i"
	    break
	}
    }
    UTF::Sleep 10 "" "Wait for additional STA messages"
}
