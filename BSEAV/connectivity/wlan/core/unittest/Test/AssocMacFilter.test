#!/bin/env utf
# -*-tcl-*-

# UTF test script for testing AP Mac Restrict.  Two STAs are
# associated to the AP, then MAC filters are set to reject the first,
# then to allow only the second.
#
# $Id$
# $Copyright Broadcom Corporation$
#

package require UTF
package require UTF::Test::ConnectAPSTA

package provide UTF::Test::AssocMacFilter 2.0

UTF::Test AssocMacFilter {AP STA1 STA2} {

    UTF::Try "$AP: Connect $STA1 $STA2" {
	ConnectAPSTA $AP [list $STA1 $STA2]
    }
    set wlname [$AP wlname]
    set mac [$STA1 macaddr]

    UTF::Try "$AP: Deny only $STA1" {
	$STA1 wl disassoc
	$STA2 wl disassoc
	$AP restart ${wlname}_macmode=deny "${wlname}_maclist=$mac"
	if {![catch {ConnectAPSTA $AP $STA1}]} {
	    error "Deny only $STA1: $STA1 associated"
	}
	if {[catch {ConnectAPSTA $AP $STA2}]} {
	    error "Deny only $STA1: $STA2 not associated"
	}
    }

    UTF::Try "$AP: Allow only $STA1" {
	$STA1 wl disassoc
	$STA2 wl disassoc
	$AP restart ${wlname}_macmode=allow "${wlname}_maclist=$mac"
	if {[catch {ConnectAPSTA $AP $STA1}]} {
	    error "Allow only $STA1: $STA1 not associated"
	}
	if {![catch {ConnectAPSTA $AP $STA2}]} {
	    error "Allow only $STA1: $STA2 associated"
	}
    }

    $AP restart ${wlname}_macmode=disabled ${wlname}_maclist=

    $STA1 wl disassoc
    $STA2 wl disassoc
    return
}