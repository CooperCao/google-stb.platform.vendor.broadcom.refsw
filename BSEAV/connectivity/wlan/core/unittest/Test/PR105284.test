#!/bin/env utf
# -*-tcl-*-
#
# PR#105288 UTF: 43241a1 ChannelSweep ASSERT(txs->status & TX_STATUS_AMPDU) in file "wlc_ampdu.c" at line 4638 (pkt_h_seqnum)
# PR#105286 UTF: 4334b2 SDIO ChannelSweep tx phy error (0x10=lengthMismatch_short)
# PR#105284 UTF: 4334b2 SDIO ChannelSweep PSM Watchdogs
# PR#105282 UTF: 4334b2 SDIO ChannelSweep ASSERT(WLPKTTAG(p)->flags & WLF_AMPDU_MPDU) in file "wlc_ampdu.c" at line 4876 (pkt_h_seqnum)
#
# Test approach is to set up a tx traffic background then rapidly
# scan.
#
# $Id$
# $Copyright Broadcom Corporation$
#

package require UTF
package require UTF::Streams
package require UTF::Test::ConnectAPSTA

UTF::Test PR105284 {AP STA args} {
    UTF::Getopts {
	{loop.arg 500 "Loop count"}
    }
    UTF::Record "Setup" {
	# Kill off any stale iperf servers - if we kill off daemons
	# it's ok, they'll get restarted.
	catch {[$AP lan] pkill -TERM iperf}
	catch {$STA pkill -TERM iperf}
	if {[catch {$STA ping $AP}]} {
	    ConnectAPSTA $AP $STA -security open
	}
	UTF::stream logginglevel ANALYZE; # Not interested in data
	UTF::stream create T -tx $STA -rx $AP -protocol tcp -reportinterval 10
	UTF::stream allstreams start
    }

    set watchdog 1; # Flag for early abort of the outer loop
    # Report in batches of 100 to keep the log files reasonable
    for {set i 0} {$i < $(loop) && $watchdog} {incr i 10} {
	UTF::Try "loop $i" {
	    for {set j 0} {$j < 10} {incr j} {
		UTF::Message INFO $STA "loop [expr {$i + $j}]"
		set watchdog 0
		$STA wl_escanresults
		set watchdog 1
	    }
	}
    }
    UTF::Record "Cleanup" {
	UTF::stream exitstreams
    }
}
