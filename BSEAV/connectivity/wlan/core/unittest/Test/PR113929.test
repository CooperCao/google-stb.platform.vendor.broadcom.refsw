#!/bin/env utf
# -*-tcl-*-
#
# PR#113929 UTF: 4335a0 sdio3.0 PM=2 ASSERT(txs->frameid == htol16(txh_info.TxFrameID)) in wlc_dotxstatus (wlc.c:34428)
#
# Test approach is to set up a tx traffic background then rapidly
# switch PM mode.
#
# $Id: 064f25b706288ab21147bc9e041bbf946fc448b4 $
# $Copyright Broadcom Corporation$
#

package require UTF
package require UTF::Streams
package require UTF::Test::ConnectAPSTA

UTF::Test PR113929 {AP STA args} {
    UTF::Getopts {
	{loop.arg 2000 "Loop count"}
    }
    UTF::Record "Setup" {
	# Kill off any stale iperf servers - if we kill off daemons
	# it's ok, they'll get restarted.
	catch {[$AP lan] pkill -TERM iperf}
	catch {$STA pkill -TERM iperf}
	if {[catch {$STA ping $AP}]} {
	    ConnectAPSTA $AP $STA -security open
	}
	UTF::stream logginglevel ANALYZE; # Not interested in data
	UTF::stream create T -tx $STA -rx $AP -protocol tcp -reportinterval 10
	UTF::stream allstreams start
    }

    set watchdog 1; # Flag for early abort of the outer loop
    # Report in batches of 100 to keep the log files reasonable
    for {set i 0} {$i < $(loop) && $watchdog} {incr i 10} {
	UTF::Try "loop $i" {
	    for {set j 0} {$j < 10} {incr j} {
		UTF::Message INFO $STA "loop [expr {$i + $j}]"
		set watchdog 0
		$STA wl PM 1
		$STA wl PM 0
		set watchdog 1
	    }
	}
    }
    UTF::Record "Cleanup" {
	UTF::stream exitstreams
    }
}
