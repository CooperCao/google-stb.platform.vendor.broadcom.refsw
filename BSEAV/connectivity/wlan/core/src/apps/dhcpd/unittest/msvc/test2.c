#include <string.h>
#include <stdio.h>

#include "dhcp.h"
#include "osl.h"
#include "packet.h"
#include "mac.h"
#include "dhcpdebug.h"

extern void exit(int);

char xp_dhcp_discover[] = {
0x01, 0x01, 0x06, 0x00, 0xb4, 0xc3, 
0x43, 0xd7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 
0x29, 0x28, 0x1d, 0xb6, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 
0x53, 0x63, 0x35, 0x01, 0x01, 0x74, 0x01, 0x01, 
0x3d, 0x07, 0x01, 0x00, 0x0c, 0x29, 0x28, 0x1d, 
0xb6, 0x0c, 0x06, 0x6b, 0x62, 0x64, 0x2d, 0x31, 
0x30, 0x3c, 0x08, 0x4d, 0x53, 0x46, 0x54, 0x20, 
0x35, 0x2e, 0x30, 0x37, 0x0b, 0x01, 0x0f, 0x03, 
0x06, 0x2c, 0x2e, 0x2f, 0x1f, 0x21, 0xf9, 0x2b, 
0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

char xp_dhcp_request[] = {
0x01, 0x01, 0x06, 0x00, 0xb4, 0xc3, 
0x43, 0xd7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 
0x29, 0x28, 0x1d, 0xb6, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82, 
0x53, 0x63, 0x35, 0x01, 0x03, 0x3d, 0x07, 0x01, 
0x00, 0x0c, 0x29, 0x28, 0x1d, 0xb6, 
0x32, 0x04, 0xc0, 0xa8, 0x10, 0x64, 
0x36, 0x04, 0x0a, 0x10, 
0xc0, 0x0f, 0x0c, 0x06, 0x6b, 0x62, 0x64, 0x2d, 
0x31, 0x30, 0x51, 0x0a, 0x00, 0x00, 0x00, 0x6b, 
0x62, 0x64, 0x2d, 0x31, 0x30, 0x2e, 0x3c, 0x08, 
0x4d, 0x53, 0x46, 0x54, 0x20, 0x35, 0x2e, 0x30, 
0x37, 0x0b, 0x01, 0x0f, 0x03, 0x06, 0x2c, 0x2e, 
0x2f, 0x1f, 0x21, 0xf9, 0x2b, 0xff };

unsigned char xpMacAddress[] = { 0x00, 0x0c, 0x29, 0x28, 0x1d, 0xb6 };
unsigned char broadcastMacAddress[] = { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };

extern int gSendCount;
extern struct Packet *gLastPacket;

int socketGet(struct Packet **p) {	
	static int Count = 0;
	static int lastSendCount = 0;
	static unsigned long tempLong = 0;

	switch(Count++) {
		case 0:
			printf("*** Validate MAC Address Filters ****\n");

			printf("Setting accept any mac address\n");
			if (DDOK != MACAllocate(broadcastMacAddress, NULL))
				printf("   FAIL\n");
			else
				printf("   PASS\n");

			printf("Sending xp discover\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			break;

		case 1:
			if (lastSendCount != gSendCount)
				printf("   PASS: Got Offer\n");
			else
				printf("   FAIL: did not get offer packet\n");

			packetDupFromTemplate((unsigned char *)&xp_dhcp_request, p, sizeof(xp_dhcp_request));
			break;

		case 2:
			printf("Sending xp request\n");
			if (lastSendCount != gSendCount)
				printf("   PASS: Got ACK\n");
			else
				printf("   FAIL: did not get ACK packet\n");

			MACFree(broadcastMacAddress);

			printf("Resetting accept any mac address\n");
			printf("Sending xp discover\n");
			packetDupFromTemplate((unsigned char *) &xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			break;

		case 3:
			if (lastSendCount != gSendCount)
				printf("   FAIL: Got Offer\n");
			else
				printf("   PASS: did not get offer packet\n");

			packetDupFromTemplate((unsigned char *) &xp_dhcp_request, p, sizeof(xp_dhcp_request));
			break;

		case 4:
			printf("Sending xp request\n");
			if (lastSendCount != gSendCount)
				printf("   FAIL: Got ACK\n");
			else
				printf("   PASS: did not get ACK packet\n");

			printf("Setting accept only xp MAC address\n");
			if (DDOK != MACAllocate(xpMacAddress, NULL))
				printf("   FAIL\n");
			else
				printf("   PASS\n");

			printf("Sending xp discover\n");
			packetDupFromTemplate((unsigned char *) &xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			break;

		case 5:
			if (lastSendCount != gSendCount)
				printf("   PASS: Got Offer\n");
			else
				printf("   FAIL: did not get offer packet\n");

			packetDupFromTemplate((unsigned char *) &xp_dhcp_request, p, sizeof(xp_dhcp_request));
			break;

		case 6:
			printf("Sending xp request\n");
			if (lastSendCount != gSendCount)
				printf("   PASS: Got ACK\n");
			else
				printf("   FAIL: did not get ACK packet\n");


			printf("Resetting accept any mac address\n");
			MACFree(xpMacAddress);

			printf("Sending xp discover\n");
			packetDupFromTemplate((unsigned char *) &xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			break;

		case 7:
			if (lastSendCount != gSendCount)
				printf("   FAIL: Got Offer\n");
			else
				printf("   PASS: did not get offer packet\n");

			packetDupFromTemplate((unsigned char *) &xp_dhcp_request, p, sizeof(xp_dhcp_request));
			break;

		case 8:
			printf("Sending xp request\n");
			if (lastSendCount != gSendCount)
				printf("   FAIL: Got ACK\n");
			else
				printf("   PASS: did not get ACK packet\n");
			
			printf("\n*** Validate Offers ****\n");
			printf("Setting accept any mac address\n");
			if (DDOK != MACAllocate(broadcastMacAddress, NULL))
				printf("   FAIL: Setting broadcastMacAddress returns fail\n");
			else
				printf("   PASS: Setting broadcastMacAddress returns OK\n");

			printf("Sending xp discover with MAC ADDRESS #1\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));

			break;

		case 9:

			tempLong = 0;
			if (lastSendCount != gSendCount) {
				printf("   PASS: Got Offer\n");
				tempLong = * (unsigned long *) &gLastPacket->Data[16];
			} else
				printf("   FAIL: did not get offer packet\n");

			printf("Sending xp discover with MAC ADDRESS #1 again\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));

			break;

		case 10:
			if (lastSendCount != gSendCount) {
				if (tempLong != (* (unsigned long *) &gLastPacket->Data[16]))
					printf("   FAIL: offered different IP\n");
				else
					printf("   PASS: offered same IP\n");
			} else
				printf("   FAIL: did not get ACK packet\n");

			printf("Sending xp discover with MAC address #2\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			(*p)->Data[0x21]++; // Give different MAC Address
			
			break;

		case 11:
			if (lastSendCount != gSendCount) {
				if (tempLong != (* (unsigned long *) &gLastPacket->Data[16]))
					printf("   PASS: offered different IP\n");
				else
					printf("   FAIL: offered same IP\n");
			} else
				printf("   FAIL: did not get ACK packet\n");
			printf("Sending xp discover with MAC address #1\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));

			break;

		case 12:
			if (lastSendCount != gSendCount) {
				if (tempLong != (* (unsigned long *) &gLastPacket->Data[16]))
					printf("   FAIL: offered different IP\n");
				else
					printf("   PASS: offered same IP address as before for #1\n");
			} else
				printf("   FAIL: did not get ACK packet\n");

			printf("Sending xp discover with MAC address #3\n");
			packetDupFromTemplate((unsigned char *)&xp_dhcp_discover, p, sizeof(xp_dhcp_discover));
			(*p)->Data[0x21]++;
			(*p)->Data[0x21]++; // Give different MAC Address
			
			break;

		case 13:
			if (lastSendCount != gSendCount) {
				if (tempLong != (* (unsigned long *) &gLastPacket->Data[16]))
					printf("   PASS: offered different IP\n");
				else
					printf("   FAIL: offered same IP\n");
			} else
				printf("   FAIL: did not get ACK packet\n");

		default:
			DHCP_Unload();
			exit(0);
	}

	lastSendCount = gSendCount;

	return DDOK;
}

main() {
	void *DHCPHandle;
	
	DHCPHandle = (void *) DHCP_init(NULL, NULL, NULL);
	DHCP_main(DHCPHandle);
}
