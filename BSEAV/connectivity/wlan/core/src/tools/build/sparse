#!/bin/bash
#
# Platform independent wrapper to call new svn sparse tool
#
# $Id$
#

PYTHON_VER_NEEDED=2.6
SVN_VER_NEEDED=1.6

# If this wrapper is called by someone else and they want a different
# sparse checkout gallery then allow them to override
if [ ! -n "$SPARSE_GALLERY" ]; then
	SPARSE_GALLERY=/projects/hnd_software/gallery-svn/release
fi

case "`uname`" in
    NetBSD|Darwin)
	# On *bsd platforms prefix native paths ahead of /tools/bin as
	# /tools/bin may not be supported there (even though /tools/bin
	# falls back to native paths on unsupported platforms)
	UNIX_PATH=/bin:/usr/bin:/tools/bin:/projects/hnd/tools/linux/bin
        UNIX_PATH="${UNIX_PATH}:${SPARSE_GALLERY}"
        PATH=${UNIX_PATH}:$PATH
        sparse_py=`which sparse.py 2> /dev/null`
        ;;
    Linux)
	UNIX_PATH=/tools/bin:/projects/hnd/tools/linux/bin
        UNIX_PATH="${UNIX_PATH}:${SPARSE_GALLERY}"
        PATH=${UNIX_PATH}:$PATH
        sparse_py=`which sparse.py 2> /dev/null`
        ;;
    *CYGWIN*)
	# Some PATH additions are used only for older Cygwins.
	# This conditional may seem strange but we need to be careful
	# about case ("Tools/Win32") and Cygwin 2.x.
	if [[ ${CYGWIN_DIRECTORY:-tools/win32} = *-* ]]; then
	    WIN_PATH=
	else
	    WIN_PATH="/cygdrive/c/tools/Subversion"
	    WIN_PATH="$WIN_PATH:/cygdrive/z/projects/hnd_tools/win/Subversion"
	    WIN_PATH="$WIN_PATH:/cygdrive/c/tools/Python"
	    WIN_PATH="$WIN_PATH:/cygdrive/z/projects/hnd_tools/win/Python"
	fi
	WIN_PATH="${WIN_PATH:+$WIN_PATH:}/cygdrive/c/tools/build"
	WIN_PATH="$WIN_PATH:/cygdrive/z/home/hwnbuild/src/tools/build"
	WIN_PATH="$WIN_PATH:/cygdrive/z${SPARSE_GALLERY}"
	PATH="$WIN_PATH:$PATH"
	sparse_py="/cygdrive/z${SPARSE_GALLERY}/sparse.py"
	sparse_py=`cygpath -m $sparse_py 2> /dev/null`
	;;
esac

python_ver_actual=`python -V 2>&1 | awk '{print $2}' | cut -d. -f1,2`
svn_ver_actual=`svn -q --version 2>&1 | cut -d. -f1,2`

if [[ $python_ver_actual < $PYTHON_VER_NEEDED ]]; then
	echo "ERROR: Need Python $PYTHON_VER_NEEDED or higher"
	echo "ERROR: Current version $python_ver_actual"
	exit 1
fi

if [[ $svn_ver_actual < $SVN_VER_NEEDED ]]; then
	echo "ERROR: Need Subversion $SVN_VER_NEEDED or higher"
	echo "ERROR: Current version $svn_ver_actual"
	exit 1
fi

if [ ! -s "$sparse_py" ]; then
	echo "ERROR: sparse_py '$sparse_py' is null or not found"
	echo "ERROR: Exiting"
	exit 1
else
	if [ -n "$VERBOSE" ]; then
		echo "DBG: Using python $python_ver_actual from `which python`"
		echo "DBG: Using svn $svn_ver_actual from `which svn`"
	fi
	echo "python $sparse_py $*"
	python $sparse_py "$@"
fi

